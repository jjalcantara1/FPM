<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>History Log - Fleet Management</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../static/supabaseClient.js"></script>
  <style>
    :root { --brand-orange: #f47621; --brand-dark: #33383f; --bg-light: #f5f7fa; }
    body { font-family: "Inter", sans-serif; color: var(--brand-dark); background: var(--bg-light); display: flex; min-height: 100vh; margin:0; }
    .sidebar { width: 240px; background: #fff; border-right: 1px solid #e9edf1; display: flex; flex-direction: column; justify-content: space-between; padding: 20px 16px; }
    .menu a { padding: 10px 12px; border-radius: 8px; text-decoration: none; color: var(--brand-dark); font-weight: 600; display: block; margin-bottom: 4px; transition: 0.2s; }
    .menu a.active, .menu a:hover { background: var(--brand-orange); color: #fff; }
    .logout a { display: block; padding: 12px; background: #fbe9dd; text-align: center; border-radius: 8px; text-decoration: none; color: var(--brand-dark); font-weight: 600; cursor: pointer; }
    .main { flex: 1; padding: 24px; }
    .card { background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    table { width: 100%; border-collapse: collapse; }
    th { background: #6c757d; color: #fff; padding: 14px; text-align: left; }
    td { padding: 14px; border-bottom: 1px solid #eee; }
    .welcome { font-weight: 600; font-size: 16px; color: var(--brand-dark); }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div>
      <div style="text-align:center; margin-bottom:20px;"><img src="flogo.png" height="40" alt="Logo"></div>
      <nav class="menu">
        <a href="dashboardf.html">Dashboard</a>
        <a href="users.html">Users</a>
        <a href="task.html">Task Assign</a>
        <a href="notifications.html">Notifications</a>
        <a href="track.html">Tracking</a>
        <a href="history.html" class="active">History Log</a>
      </nav>
    </div>
    <div class="logout"><a onclick="logout()">Logout</a></div>
  </aside>

  <main class="main">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <div>
             <div class="welcome" id="welcomeMsg">Welcome!</div>
             <h1>Activity History</h1>
        </div>
    </div>
    <div class="card">
      <table id="historyTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Activity/Ticket</th>
            <th>Location</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
            <tr><td colspan="4" style="text-align:center;">Loading history...</td></tr>
        </tbody>
      </table>
    </div>
  </main>

  <script>
    const sb = window.supabaseClient;

    async function logout() {
        await sb.auth.signOut();
        window.location.href = 'loginfleet.html';
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const { data: { session } } = await sb.auth.getSession();
        if (!session) return window.location.href = 'loginfleet.html';

        const { data: profile } = await sb.from('fleet_manager_records').select('first_name').eq('user_id', session.user.id).single();
        if(profile) document.getElementById('welcomeMsg').textContent = `Welcome, ${profile.first_name}!`;

        const { data, error } = await sb.from('vehicle_requests').select('*').eq('status', 'Completed').order('created_at', { ascending: false });
        
        const tbody = document.querySelector('#historyTable tbody');
        tbody.innerHTML = '';

        if (data && data.length > 0) {
            data.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${new Date(r.request_date).toLocaleString()}</td>
                    <td>Request ${r.ticket_id}</td>
                    <td>${r.location}</td>
                    <td style="color:green; font-weight:700;">${r.status}</td>
                `;
                tbody.appendChild(tr);
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">No history found.</td></tr>';
        }
    });
  </script>
</body>
</html>