<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fleet Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    :root {
      --brand-orange: #f47621;
      --brand-dark: #33383f;
      --muted: #70757d;
      --card-border: #e3e6ea;
      --bg-light: #f5f7fa;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Inter", sans-serif;
      color: var(--brand-dark);
      background: var(--bg-light);
      min-height: 100vh;
      display: flex;
    }

    /* Sidebar */
    .sidebar {
      width: 240px;
      background: #fff;
      border-right: 1px solid #e9edf1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 20px 16px;
    }
    .brand { text-align: center; margin-bottom: 24px; }
    .brand img { height: 40px; }
    .menu { display: flex; flex-direction: column; gap: 4px; }
    .menu a {
      padding: 10px 12px;
      border-radius: 8px;
      text-decoration: none;
      color: var(--brand-dark);
      font-weight: 600;
      transition: background 0.2s, color 0.2s;
    }
    .menu a.active, .menu a:hover { background: var(--brand-orange); color: #fff; }
    .logout a {
      display: block;
      padding: 12px;
      border-radius: 10px;
      background: #fbe9dd;
      text-align: center;
      font-weight: 600;
      text-decoration: none;
      color: var(--brand-dark);
    }

    /* Main */
    .main { flex: 1; display: flex; flex-direction: column; padding: 24px 32px; }
    .topbar {
      height: 64px;
      background: #fff;
      border-bottom: 1px solid #e9edf1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
    }
    .welcome { font-weight: 700; font-size: 16px; }

    .content { flex: 1; padding: 24px; overflow-y: auto; }
    .h1 { font-size: 28px; font-weight: 800; margin-bottom: 20px; }

    /* Cards */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-top: 40px;
      margin-bottom: 28px;
    }
    .card {
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: transform 0.2s;
      cursor: pointer;
    }
    .card:hover { transform: translateY(-3px); box-shadow: 0 6px 16px rgba(0,0,0,0.12); }
    .metric { font-size: 28px; font-weight: 800; margin-bottom: 6px; }
    .label { font-size: 14px; color: var(--muted); }

    /* Buttons */
    .btn {
      display: inline-block;
      background: var(--brand-orange);
      color: #fff;
      padding: 12px 20px;
      border-radius: 12px;
      text-decoration: none;
      font-weight: 600;
      transition: 0.2s;
      border: none;
      cursor: pointer;
    }
    .btn:hover { background: #d65e12; }

    /* Section */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .section-title { font-size: 22px; font-weight: 800; color: var(--brand-orange); }

    /* Vehicles */
    .vehicle-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 300px));
      gap: 20px;
      background: transparent;
      border: none;
      box-shadow: none;
    }
    .vehicle-card {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: transform 0.2s;
      width: 300px;
      height: auto;
      display: flex;
      flex-direction: column;
    }
    .vehicle-card:hover { transform: translateY(-3px); }
    .vehicle-photo {
      width: 100%; 
      height: 180px;
      border-radius: 12px;
      object-fit: cover;
      background: #e9edf1;
      flex-shrink: 0;
    }
    .kv { 
      margin-top: 12px; 
      font-size: 14px; 
      line-height: 1.6; 
      flex: 1;
      overflow: hidden;
    }
    .kv b { font-weight: 700; }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: #fff;
      padding: 24px;
      border-radius: 16px;
      width: 100%;
      max-width: 500px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.9);} to { opacity: 1; transform: scale(1);} }
    .modal h2 { margin-bottom: 16px; font-size: 20px; font-weight: 700; color: var(--brand-dark); }
    .form-group { margin-bottom: 14px; }
    .form-group label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 6px; color: var(--brand-dark); }
    .form-group input {
      width: 100%; padding: 10px;
      border: 1px solid var(--card-border);
      border-radius: 10px;
      font-size: 14px;
    }
    /* Style for file inputs */
    .form-group input[type="file"] {
      padding: 8px;
      background: #f9fafb;
    }
    
    .form-actions { margin-top: 20px; display: flex; justify-content: flex-end; gap: 12px; }
    .btn-secondary {
      background: #e0e0e0;
      color: var(--brand-dark);
      padding: 10px 16px;
      border-radius: 10px;
      font-weight: 600;
      text-decoration: none;
      transition: 0.2s;
      border: none;
      cursor: pointer;
    }
    .btn-secondary:hover { background: #ccc; }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div>
      <div class="brand"><img src="flogo.png" alt="Company logo" /></div>
      <nav class="menu">
        <a class="active" href="dashboardf.html">Dashboard</a>
        <a href="users.html">Users</a>
        <a href="task.html">Task Assign</a>
        <a href="notifications.html">Notifications</a>
        <a href="track.html">Tracking</a>
        <a href="history.html">History Log</a>
      </nav>
    </div>
    <div class="logout"><a href="loginfleet.html">Logout</a></div>
  </aside>

  <main class="main">
      <div class="cards">
        <div class="card"><div class="metric" id="countDrivers">0</div><div class="label">Total Drivers</div></div>
        <div class="card" onclick="window.location.href='task.html?status=Ongoing'"><div class="metric" id="countOngoing">0</div><div class="label">Ongoing Tasks</div></div>
        <div class="card" onclick="window.location.href='task.html?status=Pending'"><div class="metric" id="countPending">0</div><div class="label">Pending Tasks</div></div>
        <div class="card" onclick="window.location.href='task.html?status=Completed'"><div class="metric" id="countCompleted">0</div><div class="label">Completed Tasks</div></div>
      </div>

      <div class="section-header">
        <div class="section-title">Vehicle Information</div>
        <button class="btn" onclick="openModal()">+ Add Vehicle</button>
      </div>
      <div class="vehicle-grid" id="vehicleGrid">
      </div>
  </main>

  <div class="modal" id="vehicleModal">
    <div class="modal-content">
      <h2>Add Vehicle</h2>
      <div class="form-group"><label>Vehicle Type</label><input type="text" id="vType" placeholder="e.g. L300"></div>
      <div class="form-group"><label>Model</label><input type="text" id="vModel" placeholder="e.g. Toyota"></div>
      
      <div class="form-group">
        <label>Photo</label>
        <input type="file" id="vPhoto" accept="image/*">
      </div>
      
      <div class="form-group"><label>Plate Number</label><input type="text" id="vPlate"></div>
      
      <div class="form-group">
        <label>OR/CR Document</label>
        <input type="file" id="vORCR" accept="image/*,application/pdf">
      </div>
      
      <div class="form-actions">
        <button class="btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn" id="saveBtn" onclick="saveVehicle()">Save</button>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://bicvcqolkaokimtwimhn.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpY3ZjcW9sa2Fva2ltdHdpbWhuIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MjUzMDIwMCwiZXhwIjoyMDc4MTA2MjAwfQ.eAYHk5c53gz5y2r85Rkz_-48taKCZWii-5cR2glCMP0';
    
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function initDashboard() {
        // 1. Check Session
        const { data: { session } } = await sb.auth.getSession();
        if (!session) window.location.href = 'loginfleet.html';

        // 2. Load Metrics
        const { count: drivers } = await sb.from('fleet_drivers').select('*', { count: 'exact', head: true });
        const { count: pending } = await sb.from('vehicle_requests').select('*', { count: 'exact', head: true }).eq('status', 'Pending');
        const { count: ongoing } = await sb.from('vehicle_requests').select('*', { count: 'exact', head: true }).in('status', ['On Going', 'In Progress']);
        const { count: completed } = await sb.from('vehicle_requests').select('*', { count: 'exact', head: true }).eq('status', 'Completed');

        document.getElementById('countDrivers').textContent = drivers || 0;
        document.getElementById('countPending').textContent = pending || 0;
        document.getElementById('countOngoing').textContent = ongoing || 0;
        document.getElementById('countCompleted').textContent = completed || 0;

        // 3. Load Vehicles
        const { data: vehicles } = await sb.from('fleet_vehicles').select('*').order('created_at', {ascending: false});
        const grid = document.getElementById("vehicleGrid");
        grid.innerHTML = '';

        if (vehicles && vehicles.length > 0) {
            vehicles.forEach(v => {
                const card = document.createElement("div");
                card.className = "vehicle-card";
                // Use a placeholder if photo_url is null
                const img = v.photo_url ? v.photo_url : 'vehicle1.jpg'; 
                
                let orcrHtml = '';
                if(v.orcr_url) {
                     orcrHtml = `<div><div style="font-weight: 700; margin-top: 6px;">OR/CR:</div><a href="${v.orcr_url}" target="_blank" style="color:var(--brand-orange);text-decoration:none;">View Document</a></div>`;
                } else {
                     orcrHtml = `<div><div style="font-weight: 700; margin-top: 6px;">OR/CR:</div><span style="color:var(--muted)">No document</span></div>`;
                }

                card.innerHTML = `
                  <img class="vehicle-photo" src="${img}" alt="${v.type}" onerror="this.src='vehicle1.jpg'" />
                  <div class="kv">
                    <div><b>Type:</b> ${v.type}</div>
                    <div><b>Model:</b> ${v.model || '-'}</div>
                    <div><b>Plate:</b> ${v.plate_number}</div>
                    <div><b>Status:</b> ${v.status}</div>
                    ${orcrHtml}
                  </div>`;
                grid.appendChild(card);
            });
        } else {
            grid.innerHTML = '<p style="color:var(--muted)">No vehicles found.</p>';
        }
    }

    // Modal Functions
    function openModal() { document.getElementById("vehicleModal").style.display = "flex"; }
    function closeModal() { document.getElementById("vehicleModal").style.display = "none"; }

    // Helper to upload file
    async function uploadFile(file, folder) {
        const fileName = `${Date.now()}_${file.name.replace(/\s+/g, '-')}`;
        const filePath = `${folder}/${fileName}`;
        
        // Assuming you have a public bucket named 'fleet-assets'
        // You must create this bucket in your Supabase Storage first
        const { data, error } = await sb.storage
            .from('fleet-assets') 
            .upload(filePath, file);

        if (error) throw error;

        // Get public URL
        const { data: publicData } = sb.storage
            .from('fleet-assets')
            .getPublicUrl(filePath);
            
        return publicData.publicUrl;
    }

    async function saveVehicle() {
        const btn = document.getElementById('saveBtn');
        btn.disabled = true;
        btn.textContent = 'Saving...';

        const type = document.getElementById("vType").value;
        const model = document.getElementById("vModel").value;
        const plate = document.getElementById("vPlate").value;
        
        const photoFile = document.getElementById("vPhoto").files[0];
        const orcrFile = document.getElementById("vORCR").files[0];

        if(!type || !plate) {
            alert("Type and Plate Number are required.");
            btn.disabled = false;
            btn.textContent = 'Save';
            return;
        }

        let photoUrl = null;
        let orcrUrl = null;

        try {
            // Upload Photo if exists
            if (photoFile) {
                photoUrl = await uploadFile(photoFile, 'vehicles');
            }

            // Upload OR/CR if exists
            if (orcrFile) {
                orcrUrl = await uploadFile(orcrFile, 'documents');
            }

            const { error } = await sb.from('fleet_vehicles').insert([{
                type, 
                model, 
                plate_number: plate, 
                photo_url: photoUrl, 
                orcr_url: orcrUrl, 
                status: 'Idle'
            }]);

            if(error) {
                throw error;
            }

            alert("Vehicle added successfully!");
            closeModal();
            initDashboard();
            
            // Reset form
            document.getElementById("vType").value = "";
            document.getElementById("vModel").value = "";
            document.getElementById("vPlate").value = "";
            document.getElementById("vPhoto").value = "";
            document.getElementById("vORCR").value = "";

        } catch (error) {
            console.error(error);
            alert("Error: " + (error.message || "Failed to save vehicle."));
        } finally {
            btn.disabled = false;
            btn.textContent = 'Save';
        }
    }

    initDashboard();
  </script>
</body>
</html>