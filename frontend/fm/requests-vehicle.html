<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Requests Vehicle - Fleet Management</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --brand-orange:#f47621; --brand-dark:#33383f; --muted:#70757d; --card:#fff; --border:#e9edf1; }
    *{box-sizing:border-box; margin:0; padding:0}
    body{font-family:"Inter",sans-serif; color:var(--brand-dark); background:#f3f5f7; min-height:100vh; display:flex}
    .sidebar{width:240px; background:#fff; border-right:1px solid var(--border); display:flex; flex-direction:column; justify-content:space-between; padding:20px 16px}
    .brand{text-align:center; margin-bottom:24px} .brand img{height:40px}
    .menu{display:flex; flex-direction:column; gap:4px}
    .menu a{padding:10px 12px; border-radius:8px; text-decoration:none; color:var(--brand-dark); font-weight:600; display:block;}
    .menu a.active,.menu a:hover{background:var(--brand-orange); color:#fff}
    .logout a{display:block; padding:10px 12px; border-radius:8px; background:#fbe9dd; text-align:center; color:var(--brand-dark); font-weight:600; text-decoration:none}
    .main{flex:1; display:flex; flex-direction:column}
    .topbar{height:64px; background:#fff; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; padding:0 24px}
    .content{flex:1; padding:24px; overflow-y:auto}
    .page-title{font-size:28px; font-weight:800; margin-bottom:20px}
    .card{background:#fff; border:1px solid var(--border); border-radius:12px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,.05)}
    table{width:100%; border-collapse:collapse}
    thead{background:#6c757d; color:#fff}
    th,td{padding:12px; border-bottom:1px solid #e9ecef; text-align:left; font-size:14px;}
    .status-pill{padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700}
    .status-pending{background:#fff3cd; color:#856404}
    .status-approved{background:#e8f5e9; color:#2e7d32}
    .btn-view{background:#1e88e5; color:#fff; padding:6px 12px; border-radius:8px; border:none; cursor:pointer;}
    
    /* Modal */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; z-index:1000}
    .modal-content{width:100%; max-width:500px; background:#fff; border-radius:12px; padding:20px;}
    .field{margin-bottom:12px} .label{font-weight:700; margin-bottom:4px; display:block;}
    select{width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;}
  </style>
</head>
<body>
  <aside class="sidebar">
    <div>
      <div class="brand"><img src="flogo.png" alt="Company logo" /></div>
      <nav class="menu">
        <a href="dashboardf.html">Dashboard</a>
        <a href="users.html">Users</a>
        <a href="task.html">Task Assign</a>
        <a class="active" href="requests-vehicle.html">Requests Vehicle</a>
        <a href="track.html">Tracking</a>
        <a href="history.html">History Log</a>
      </nav>
    </div>
    <div class="logout"><a href="loginfleet.html">Logout</a></div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="welcome">Welcome, Michael!</div>
    </div>
    <div class="content">
      <div class="page-title">Requests Vehicle</div>
      <div class="card">
        <table id="reqTable">
          <thead>
            <tr>
              <th>Ticket</th>
              <th>Date</th>
              <th>Location</th>
              <th>Requested By</th>
              <th>Status</th>
              <th>Priority</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </main>

  <div id="viewModal" class="modal">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;margin-bottom:16px">
        <h2 style="margin:0">Request Details</h2>
        <span onclick="closeModal()" style="cursor:pointer;font-size:24px">&times;</span>
      </div>
      <div class="field"><div class="label">Ticket:</div><div id="mTicket"></div></div>
      <div class="field"><div class="label">Location:</div><div id="mLocation"></div></div>
      
      <div class="field">
        <div class="label">Assign Driver:</div>
        <select id="assignDriver"></select>
      </div>
      <div class="field">
        <div class="label">Assign Vehicle:</div>
        <select id="assignVehicle"></select>
      </div>
      
      <div style="text-align:right; margin-top:20px;">
        <button class="btn-view" style="background:#6c757d" onclick="closeModal()">Cancel</button>
        <button class="btn-view" style="background:#28a745" id="approveBtn">Approve & Assign</button>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://bicvcqolkaokimtwimhn.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpY3ZjcW9sa2Fva2ltdHdpbWhuIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MjUzMDIwMCwiZXhwIjoyMDc4MTA2MjAwfQ.eAYHk5c53gz5y2r85Rkz_-48taKCZWii-5cR2glCMP0';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function fetchRequests() {
        const { data, error } = await supabase.from('vehicle_requests').select('*').order('created_at', {ascending: false});
        if (error) return console.error(error);

        const tbody = document.querySelector('#reqTable tbody');
        tbody.innerHTML = '';

        data.forEach(r => {
            let badgeClass = 'status-pending';
            if(r.status === 'Approved') badgeClass = 'status-approved';

            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${r.ticket_id || 'N/A'}</td>
              <td>${new Date(r.request_date).toLocaleDateString()}</td>
              <td>${r.location}</td>
              <td>${r.requested_by}</td>
              <td><span class="status-pill ${badgeClass}">${r.status}</span></td>
              <td>${r.priority}</td>
              <td><button class="btn-view" onclick="openDetails(${r.id})">View</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    let currentReqId = null;

    async function openDetails(id) {
        currentReqId = id;
        const { data: req } = await supabase.from('vehicle_requests').select('*').eq('id', id).single();
        
        document.getElementById('mTicket').textContent = req.ticket_id;
        document.getElementById('mLocation').textContent = req.location;

        // Load Drivers
        const { data: drivers } = await supabase.from('fleet_drivers').select('*').eq('status', 'Active');
        const dSelect = document.getElementById('assignDriver');
        dSelect.innerHTML = '<option value="">Select Driver</option>';
        drivers.forEach(d => {
            dSelect.innerHTML += `<option value="${d.id}">${d.first_name} ${d.last_name}</option>`;
        });

        // Load Vehicles
        const { data: vehicles } = await supabase.from('fleet_vehicles').select('*').eq('status', 'Idle');
        const vSelect = document.getElementById('assignVehicle');
        vSelect.innerHTML = '<option value="">Select Vehicle</option>';
        vehicles.forEach(v => {
            vSelect.innerHTML += `<option value="${v.id}">${v.type} (${v.plate_number})</option>`;
        });

        document.getElementById('viewModal').style.display = 'flex';
    }

    document.getElementById('approveBtn').onclick = async () => {
        const driverId = document.getElementById('assignDriver').value;
        const vehicleId = document.getElementById('assignVehicle').value;

        if(!driverId || !vehicleId) return alert("Please assign both driver and vehicle.");

        // Update Request
        await supabase.from('vehicle_requests').update({
            status: 'Approved', driver_id: driverId, vehicle_id: vehicleId
        }).eq('id', currentReqId);

        // Update Vehicle Status
        await supabase.from('fleet_vehicles').update({ status: 'Active' }).eq('id', vehicleId);

        alert("Request Approved!");
        closeModal();
        fetchRequests();
    };

    function closeModal() { document.getElementById('viewModal').style.display = 'none'; }
    
    fetchRequests();
  </script>
</body>
</html>