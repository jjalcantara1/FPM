<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Task Assign - Fleet Management</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../static/supabaseClient.js"></script>
  <style>
    :root { --brand-orange: #f47621; --brand-dark: #33383f; --bg-light: #f5f7fa; --muted: #70757d; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: "Inter", sans-serif; color: var(--brand-dark); background: var(--bg-light); display: flex; min-height: 100vh; margin: 0; }
    .sidebar { width: 240px; background: #fff; border-right: 1px solid #e9edf1; display: flex; flex-direction: column; justify-content: space-between; padding: 20px 16px; }
    .menu a { padding: 10px 12px; border-radius: 8px; text-decoration: none; color: var(--brand-dark); font-weight: 600; display: block; margin-bottom: 4px; transition: 0.2s; }
    .menu a.active, .menu a:hover { background: var(--brand-orange); color: #fff; }
    .logout a { display: block; padding: 12px; background: #fbe9dd; text-align: center; border-radius: 8px; text-decoration: none; color: var(--brand-dark); font-weight: 600; cursor: pointer; }
    .main { flex: 1; padding: 24px; }
    .card { background: #fff; border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    /* Summary Cards */
    .task-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .summary-card { background: white; border: 1px solid #e3e6ea; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .summary-card:nth-child(1) { border-left: 4px solid var(--brand-orange); }
    .summary-card:nth-child(2) { border-left: 4px solid #ffc107; }
    .summary-card:nth-child(3) { border-left: 4px solid #28a745; }
    .summary-card:nth-child(4) { border-left: 4px solid #007bff; }
    .summary-label { font-size: 14px; color: var(--brand-orange); font-weight: 600; }
    .summary-count { font-size: 32px; font-weight: 800; color: var(--brand-dark); }
    
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 12px; background: #6c757d; color: #fff; }
    td { padding: 12px; border-bottom: 1px solid #eee; }
    .status-pending { color: #ffc107; font-weight: 700; }
    .status-progress { color: #007bff; font-weight: 700; }
    .status-completed { color: #28a745; font-weight: 700; }
    .status-onhold { color: #ffc107; font-weight: 700; }
    .btn-view { background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: 600; }
    
    /* Modal Overlay */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: white; padding: 24px; border-radius: 12px; width: 640px; max-width: 95%; max-height: 85vh; overflow-y: auto; position: relative; }
    .modal-close { position: absolute; top: 10px; right: 12px; background: transparent; border: none; font-size: 22px; cursor: pointer; }
    .modal-title { margin: 6px 32px 16px 0; color: var(--brand-orange); }
    .detail-row { display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 6px; margin-bottom: 12px; }
    
    /* Confirmation Modal */
    .confirm-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 2000; }
    .confirm-content { background: white; padding: 30px; border-radius: 12px; width: 500px; max-width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
    .confirm-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
    .confirm-icon { width: 48px; height: 48px; background: #fff3cd; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #ffc107; }
    .confirm-title { font-size: 20px; font-weight: 700; margin: 0; }
    .confirm-buttons { display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px; }
    .confirm-btn { padding: 10px 24px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
    .confirm-btn-cancel { background: #e9ecef; color: #333; }
    .confirm-btn-confirm { background: #ffc107; color: white; }
    .confirm-textarea { width: 100%; padding: 12px; border: 2px solid #e3e6ea; border-radius: 8px; min-height: 100px; margin-top: 8px; }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div>
      <div style="text-align:center; margin-bottom:24px;"><img src="flogo.png" height="40" alt="Logo"></div>
      <nav class="menu">
        <a href="dashboardf.html">Dashboard</a>
        <a href="users.html">Users</a>
        <a href="task.html" class="active">Task Assign</a>
        <a href="notifications.html">Notifications</a>
        <a href="track.html">Tracking</a>
        <a href="history.html">History Log</a>
      </nav>
    </div>
    <div class="logout"><a onclick="logout()">Logout</a></div>
  </aside>

  <main class="main">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <div>
            <div class="welcome" id="welcomeMsg">Welcome!</div>
            <h1>Task Assignment Dashboard</h1>
        </div>
        <div id="currentDate" style="color:#666;"></div>
    </div>
      
    <div class="task-summary">
      <div class="summary-card" data-status="today">
        <div class="summary-label">Task's Today</div>
        <div class="summary-count" id="count-today">0</div>
      </div>
      <div class="summary-card" data-status="pending">
        <div class="summary-label">Pending</div>
        <div class="summary-count" id="count-pending">0</div>
      </div>
      <div class="summary-card" data-status="completed">
        <div class="summary-label">Completed</div>
        <div class="summary-count" id="count-completed">0</div>
      </div>
      <div class="summary-card" data-status="ongoing">
        <div class="summary-label">Ongoing</div>
        <div class="summary-count" id="count-ongoing">0</div>
      </div>
    </div>

    <div class="task-controls">
      <div class="filter-section">
         <select id="statusFilter" onchange="filterTasks()" style="padding: 8px; border-radius: 6px;">
             <option value="">All Status</option>
             <option value="Pending">Pending</option>
             <option value="In Progress">In Progress</option>
             <option value="Completed">Completed</option>
         </select>
      </div>
    </div>

    <div class="task-table-container card">
      <table class="task-table">
        <thead>
          <tr>
            <th>Ticket</th>
            <th>Date</th>
            <th>Location</th>
            <th>Status</th>
            <th>Assignee</th>
            <th>View</th>
          </tr>
        </thead>
        <tbody id="tasksBody"></tbody>
      </table>
    </div>
  </main>

  <script>
    const sb = window.supabaseClient;
    let currentTask = null; // Store currently opened task for modal actions

    async function logout() {
        await sb.auth.signOut();
        window.location.href = 'loginfleet.html';
    }

    async function initPage() {
        const { data: { session } } = await sb.auth.getSession();
        if (!session) return window.location.href = 'loginfleet.html';

        // 1. Load Profile
        const { data: profile } = await sb.from('fleet_manager_records').select('first_name').eq('user_id', session.user.id).single();
        if (profile) document.getElementById('welcomeMsg').textContent = `Welcome, ${profile.first_name}!`;
        
        // 2. Set Date
        const now = new Date();
        document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        // 3. Fetch Tasks & Drivers
        fetchTasks();
    }

    async function fetchTasks() {
        const filter = document.getElementById('statusFilter').value;
        
        let query = sb.from('vehicle_requests').select(`
            *,
            fleet_drivers (first_name, last_name),
            fleet_vehicles (plate_number, type)
        `).order('created_at', {ascending: false});

        if (filter) query = query.eq('status', filter);

        const { data, error } = await query;
        if (error) return console.error(error);

        renderTasks(data || []);
        updateCounts(data || []);
    }

    function renderTasks(tasks) {
        const tbody = document.getElementById('tasksBody');
        tbody.innerHTML = '';
        
        if (tasks.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">No tasks found.</td></tr>';
            return;
        }

        tasks.forEach(t => {
            const driver = t.fleet_drivers ? `${t.fleet_drivers.first_name} ${t.fleet_drivers.last_name}` : 'Unassigned';
            let statusClass = 'status-pending';
            if(t.status === 'Completed') statusClass = 'status-completed';
            if(t.status === 'In Progress' || t.status === 'On Going') statusClass = 'status-progress';
            if(t.status === 'On Hold') statusClass = 'status-onhold';

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${t.ticket_id || t.id}</td>
                <td>${new Date(t.request_date).toLocaleDateString()}</td>
                <td>${t.location}</td>
                <td><span class="${statusClass}">${t.status}</span></td>
                <td>${driver}</td>
                <td><button class="btn-view" onclick='openTaskDetails(${JSON.stringify(t).replace(/'/g, "&#39;")})'>View</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updateCounts(tasks) {
        let pending = 0, ongoing = 0, completed = 0, today = 0;
        const todayStr = new Date().toISOString().split('T')[0];

        tasks.forEach(t => {
            const s = (t.status || '').toLowerCase();
            if(s === 'pending') pending++;
            else if(s === 'in progress' || s === 'on going') ongoing++;
            else if(s === 'completed') completed++;
            
            if(t.request_date && t.request_date.startsWith(todayStr)) today++;
        });

        document.getElementById('count-pending').textContent = pending;
        document.getElementById('count-ongoing').textContent = ongoing;
        document.getElementById('count-completed').textContent = completed;
        document.getElementById('count-today').textContent = today;
    }

    // --- Modal Logic ---
    async function openTaskDetails(task) {
        currentTask = task;
        
        // Fetch Drivers and Vehicles for dropdowns
        const { data: drivers } = await sb.from('fleet_drivers').select('*').eq('status', 'Active');
        const { data: vehicles } = await sb.from('fleet_vehicles').select('*').eq('status', 'Idle');

        // Create Modal UI
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        
        let actionSection = '';
        
        // Drivers Options
        const driverOptions = drivers ? drivers.map(d => `<option value="${d.id}">${d.first_name} ${d.last_name}</option>`).join('') : '';
        // Vehicle Options
        const vehicleOptions = vehicles ? vehicles.map(v => `<option value="${v.id}">${v.type} - ${v.plate_number}</option>`).join('') : '';

        if (task.status === 'Pending') {
            actionSection = `
              <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e3e6ea;">
                <label style="display:block; font-weight:600; margin-bottom:8px;">Assign Driver</label>
                <select id="assignDriver" style="width:100%; padding:10px; border:1px solid #ddd; margin-bottom:16px; border-radius:6px;">
                   <option value="">Select driver...</option>
                   ${driverOptions}
                </select>
                
                <label style="display:block; font-weight:600; margin-bottom:8px;">Assign Vehicle</label>
                <select id="assignVehicle" style="width:100%; padding:10px; border:1px solid #ddd; margin-bottom:16px; border-radius:6px;">
                   <option value="">Select vehicle...</option>
                   ${vehicleOptions}
                </select>
                
                <div style="display:flex; justify-content:flex-end; gap:12px;">
                  <button onclick="putOnHold()" style="padding:10px 20px; border:none; background:#ffc107; color:white; border-radius:6px; cursor:pointer;">On Hold</button>
                  <button onclick="approveTask()" style="padding:10px 20px; border:none; background:#28a745; color:white; border-radius:6px; cursor:pointer;">Approve & Assign</button>
                </div>
              </div>`;
        } else if (['In Progress', 'On Going'].includes(task.status)) {
            actionSection = `
              <div style="margin-top: 20px; display: flex; justify-content: flex-end;">
                <button onclick="completeTask()" style="padding: 10px 24px; border: none; background: #007bff; color: white; border-radius: 6px; cursor: pointer;">Mark as Done</button>
              </div>`;
        }

        // Safe handling of linked data
        const driverName = task.fleet_drivers ? `${task.fleet_drivers.first_name} ${task.fleet_drivers.last_name}` : 'N/A';
        const vehicleInfo = task.fleet_vehicles ? `${task.fleet_vehicles.type} (${task.fleet_vehicles.plate_number})` : 'N/A';

        modal.innerHTML = `
            <div class="modal-content">
              <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
              <h3 class="modal-title">Task Details</h3>
              <div class="detail-row"><strong>Ticket:</strong> <span>${task.ticket_id}</span></div>
              <div class="detail-row"><strong>Location:</strong> <span>${task.location}</span></div>
              <div class="detail-row"><strong>Status:</strong> <span>${task.status}</span></div>
              <div class="detail-row"><strong>Current Driver:</strong> <span>${driverName}</span></div>
              <div class="detail-row"><strong>Current Vehicle:</strong> <span>${vehicleInfo}</span></div>
              <div class="detail-row"><strong>Remarks:</strong> <span>${task.remarks || 'None'}</span></div>
              ${actionSection}
            </div>
        `;
        document.body.appendChild(modal);
    }

    // --- Actions ---
    async function approveTask() {
        const driverId = document.getElementById('assignDriver').value;
        const vehicleId = document.getElementById('assignVehicle').value;
        
        if(!driverId || !vehicleId) return alert("Please select both Driver and Vehicle");

        // 1. Update Request
        await sb.from('vehicle_requests').update({ 
            status: 'In Progress', 
            driver_id: driverId, 
            vehicle_id: vehicleId 
        }).eq('id', currentTask.id);

        // 2. Update Vehicle Status
        await sb.from('fleet_vehicles').update({ status: 'Active' }).eq('id', vehicleId);
        // 3. Update Driver Status
        await sb.from('fleet_drivers').update({ status: 'On Trip' }).eq('id', driverId);

        closeAllModals();
        fetchTasks();
        alert("Task Approved and Assigned!");
    }

    function putOnHold() {
        const modal = document.createElement('div');
        modal.className = 'confirm-modal';
        modal.innerHTML = `
            <div class="confirm-content">
                <h3 class="confirm-title">Put On Hold</h3>
                <textarea id="holdReason" class="confirm-textarea" placeholder="Reason..."></textarea>
                <div class="confirm-buttons">
                    <button class="confirm-btn confirm-btn-cancel" onclick="this.closest('.confirm-modal').remove()">Cancel</button>
                    <button class="confirm-btn confirm-btn-confirm" onclick="confirmHold()">Confirm</button>
                </div>
            </div>`;
        document.body.appendChild(modal);
    }

    async function confirmHold() {
        const reason = document.getElementById('holdReason').value;
        await sb.from('vehicle_requests').update({ status: 'On Hold', remarks: reason }).eq('id', currentTask.id);
        closeAllModals();
        fetchTasks();
    }

    function completeTask() {
        if(confirm("Mark this task as completed? Vehicle will be set to Idle.")) {
            finalizeCompletion();
        }
    }

    async function finalizeCompletion() {
        // Update Task
        await sb.from('vehicle_requests').update({ status: 'Completed' }).eq('id', currentTask.id);
        // Free up vehicle if assigned
        if(currentTask.vehicle_id) {
            await sb.from('fleet_vehicles').update({ status: 'Idle' }).eq('id', currentTask.vehicle_id);
        }
        // Free up driver
        if(currentTask.driver_id) {
            await sb.from('fleet_drivers').update({ status: 'Active' }).eq('id', currentTask.driver_id);
        }
        closeAllModals();
        fetchTasks();
    }

    function closeAllModals() {
        document.querySelectorAll('.modal-overlay, .confirm-modal').forEach(el => el.remove());
    }
    
    function filterTasks() { fetchTasks(); }

    document.addEventListener('DOMContentLoaded', initPage);
  </script>
</body>
</html>