<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tracking - Fleet Management</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../static/supabaseClient.js"></script>
  <style>
    :root { --brand-orange: #f47621; --brand-dark: #33383f; --bg-light: #f5f7fa; }
    body { font-family: "Inter", sans-serif; color: var(--brand-dark); background: var(--bg-light); display: flex; min-height: 100vh; margin:0; }
    .sidebar { width: 240px; background: #fff; border-right: 1px solid #e9edf1; display: flex; flex-direction: column; justify-content: space-between; padding: 20px 16px; }
    .menu a { padding: 10px 12px; border-radius: 8px; text-decoration: none; color: var(--brand-dark); font-weight: 600; display: block; margin-bottom: 4px; transition: 0.2s; }
    .menu a.active, .menu a:hover { background: var(--brand-orange); color: #fff; }
    .logout a { display: block; padding: 12px; background: #fbe9dd; text-align: center; border-radius: 8px; text-decoration: none; color: var(--brand-dark); font-weight: 600; cursor: pointer; }
    .main { flex: 1; padding: 24px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
    .card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .status { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 700; text-transform: uppercase; }
    .active-status { background: #dcfce7; color: #166534; }
    .idle-status { background: #fee2e2; color: #991b1b; }
    .welcome { font-weight: 600; font-size: 16px; color: var(--brand-dark); }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div>
      <div style="text-align:center; margin-bottom:24px;"><img src="flogo.png" height="40" alt="Logo"></div>
      <nav class="menu">
        <a href="dashboardf.html">Dashboard</a>
        <a href="users.html">Users</a>
        <a href="task.html">Task Assign</a>
        <a href="notifications.html">Notifications</a>
        <a href="track.html" class="active">Tracking</a>
        <a href="history.html">History Log</a>
      </nav>
    </div>
    <div class="logout"><a onclick="logout()">Logout</a></div>
  </aside>

  <main class="main">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h1>Vehicle Tracking</h1>
        <div class="welcome" id="welcomeMsg">Welcome!</div>
    </div>
    <div class="grid" id="vehicleGrid">
        <p>Loading vehicles...</p>
    </div>
  </main>

  <script>
    const sb = window.supabaseClient;

    async function logout() {
        await sb.auth.signOut();
        window.location.href = 'loginfleet.html';
    }

    async function initTracking() {
        const { data: { session } } = await sb.auth.getSession();
        if (!session) {
            window.location.href = 'loginfleet.html';
            return;
        }

        const { data: profile } = await sb.from('fleet_manager_records').select('first_name').eq('user_id', session.user.id).single();
        if(profile) document.getElementById('welcomeMsg').textContent = `Welcome, ${profile.first_name}!`;

        loadVehicles();
    }

    async function loadVehicles() {
        const { data: vehicles, error } = await sb.from('fleet_vehicles').select('*');
        if(error) return console.error(error);

        const grid = document.getElementById('vehicleGrid');
        grid.innerHTML = '';

        if (!vehicles || vehicles.length === 0) {
            grid.innerHTML = '<p>No vehicles found.</p>';
            return;
        }

        vehicles.forEach(v => {
            const statusClass = v.status === 'Active' ? 'active-status' : 'idle-status';
            // Map to static full map files based on vehicle type/id logic for demo
            const mapLink = `vehiclefullmap${(v.id % 3) + 1}.html`; 
            
            const el = document.createElement('div');
            el.className = 'card';
            el.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3 style="margin:0">${v.plate_number}</h3>
                    <span class="status ${statusClass}">${v.status}</span>
                </div>
                <p style="margin:4px 0; color:#666;">Type: <strong>${v.type}</strong></p>
                <p style="margin:4px 0; color:#666;">Model: ${v.model || 'N/A'}</p>
                <div style="height: 150px; background: #eee; margin: 14px 0; display:flex; align-items:center; justify-content:center; border-radius:8px; overflow:hidden;">
                    <img src="vehicleloc.png" style="width:100%; height:100%; object-fit:cover;">
                </div>
                <a href="${mapLink}" style="color: var(--brand-orange); font-weight: 700; text-decoration: none; display:block; text-align:center;">View Full Map â†’</a>
            `;
            grid.appendChild(el);
        });
    }

    document.addEventListener('DOMContentLoaded', initTracking);
  </script>
</body>
</html>