<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FINSI Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="./dashboard.css" />
    <link rel="stylesheet" href="./dashboard.mobile.css" media="(max-width: 1023px)" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      /* Added style for the requested state */
      .btn-requested {
        background-color: #f59e0b !important; /* Orange color */
        color: white !important;
        border: none !important;
        pointer-events: none; /* Prevent double clicking */
        opacity: 0.9;
      }
    </style>
  </head>
  <body>
    <div class="mobile-layout">
      <header class="status-bar" aria-hidden="true">
        <div class="status-icons"></div>
      </header>

      <header class="hero-header" aria-label="Greeting">
        <div class="hero-shape"></div>
        <div class="hero-content">
          <p class="hero-greeting">Good Afternoon</p>
          <p class="hero-subtitle">Welcome back!</p>
        </div>
      </header>

      <main class="main-content">
        <section class="mobile-content-section mobile-content-section-active" data-mobile-content="assignment">
          <div class="assignments-card">
            <div class="assignments-header">Assignments</div>

            <div class="assignment-tabs" role="tablist">
              <button class="tab tab-active" type="button" data-tab="pending">Pending</button>
              <button class="tab" type="button" data-tab="ongoing">Ongoing</button>
              <button class="tab" type="button" data-tab="completed">Completed</button>
            </div>

            <div class="assignment-list">
              <div class="task-container task-container-active" data-container="pending">
                <div style="text-align:center; padding:20px; color:#888;">Loading pending tasks...</div>
              </div>
              <div class="task-container" data-container="ongoing"></div>
              <div class="task-container" data-container="completed"></div>
            </div>
          </div>
        </section>

        <section class="mobile-content-section" data-mobile-content="history">
          <div class="mobile-section-card">
            <div class="mobile-section-header">Assignment History</div>
            <div class="mobile-history-filter">
              <label for="mobileHistoryDate" class="mobile-history-filter-label">Date</label>
              <select id="mobileHistoryDate" class="mobile-history-select">
                <option value="all" selected>All</option>
                <option value="today">Today</option>
                <option value="yesterday">Yesterday</option>
                <option value="older">Older</option>
              </select>
            </div>
            <div class="mobile-history-list-container">
                </div>
          </div>
        </section>

        <section class="mobile-content-section" data-mobile-content="notification">
          <div class="notif-page">
            <div class="notif-header">
              <h2 class="notif-title">Notification</h2>
            </div>
            <div class="mobile-notification-list-container">
                </div>
          </div>
        </section>

        <section class="mobile-content-section" data-mobile-content="profile">
          <div class="mobile-section-card">
            <div class="mobile-section-header">Profile</div>
            <div class="mobile-profile-content">
              <div class="mobile-profile-avatar">
                <span class="mobile-profile-initials">--</span>
              </div>
              <div class="mobile-profile-info">
                <div class="mobile-profile-name">Loading...</div>
                <div class="mobile-profile-role">Field Engineer</div>
                <div class="mobile-profile-email">...</div>
              </div>
              <div class="mobile-profile-stats">
                <div class="mobile-stat">
                  <div class="mobile-stat-number stat-total">0</div>
                  <div class="mobile-stat-label">Total</div>
                </div>
                <div class="mobile-stat">
                  <div class="mobile-stat-number stat-completed">0</div>
                  <div class="mobile-stat-label">Completed</div>
                </div>
                <div class="mobile-stat">
                  <div class="mobile-stat-number stat-rate">0%</div>
                  <div class="mobile-stat-label">Success Rate</div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="mobile-assignment-details" id="mobileAssignmentDetails">
          <div class="mobile-details-header">
            <button class="mobile-back-btn" onclick="closeMobileAssignmentDetails()">
              <span class="mobile-back-icon">‚Üê</span>
              <span>Back</span>
            </button>
          </div>
          
          <div class="mobile-details-content">
            <div class="mobile-details-card">
              <div class="mobile-details-title-section">
                <h1 class="mobile-details-title" id="mTitle"></h1>
              </div>
              
              <div class="mobile-details-meta">
                <p class="mobile-details-site" id="mSite"></p>
                <p class="mobile-details-due" id="mDue"></p>
              </div>

              <div class="mobile-details-info">
                <div class="mobile-detail-item">
                  <strong>Ticket Number</strong><br><span id="mTicket"></span>
                </div>
                <div class="mobile-detail-item">
                  <strong>Date & Time</strong><br><span id="mDateTime"></span>
                </div>
                <div class="mobile-detail-item">
                  <strong>Priority</strong><br><span id="mPriority"></span>
                </div>
                <div class="mobile-detail-item">
                  <strong>Type</strong><br><span id="mType"></span>
                </div>
                <div class="mobile-detail-item">
                  <strong>Description</strong><br><span id="mDescription"></span>
                </div>
                <div class="mobile-detail-item">
                  <strong>Remarks</strong><br><span id="mRemarks"></span>
                </div>
              </div>
            </div>
          </div>

          <div class="mobile-details-footer">
            <button class="mobile-action-btn" id="mobileActionBtn" onclick="acknowledgeAssignment()">ACKNOWLEDGE</button>
            <button class="mobile-action-btn request-vehicle" id="mobileRequestMaterialBtn" style="display:none;" onclick="requestMaterial()">REQUEST MATERIAL</button>
            <button class="mobile-action-btn" id="mobileMarkCompletedBtn" style="display:none;" onclick="markAsCompleted()">MARK AS COMPLETED</button>
          </div>
        </section>
      </main>

      <nav class="bottom-nav" aria-label="Bottom navigation">
        <button class="nav-item nav-item-active" type="button" data-mobile-page="assignment">
          <span class="nav-icon nav-icon-assignment" aria-hidden="true">üìÑ</span>
          <span class="nav-label">Assignment</span>
        </button>
        <button class="nav-item" type="button" data-mobile-page="history">
          <span class="nav-icon nav-icon-history" aria-hidden="true">üïí</span>
          <span class="nav-label">History</span>
        </button>
        <button class="nav-item" type="button" data-mobile-page="notification">
          <span class="nav-icon nav-icon-notification" aria-hidden="true">üîî</span>
          <span class="nav-label">Notification</span>
        </button>
        <button class="nav-item" type="button" data-mobile-page="profile">
          <span class="nav-icon nav-icon-profile" aria-hidden="true">üë§</span>
          <span class="nav-label">Profile</span>
        </button>
      </nav>
    </div>

    <div class="desktop-layout">
      <aside class="main-nav-sidebar">
        <div class="nav-header">
          <img src="finsi_logo.png" alt="FINSI Logo" class="brand-logo" />
        </div>

        <div class="user-profile">
          <div class="user-avatar">
            <img src="aiface.jpg" alt="Profile" />
          </div>
          <div class="user-name profile-name">Loading...</div>
        </div>

        <nav class="main-navigation">
          <a href="#" class="nav-item nav-item-active" data-main-page="assignment">
             <span class="nav-item-icon">üìÑ</span> Assignment
          </a>
          <a href="#" class="nav-item" data-main-page="history">
             <span class="nav-item-icon">üïí</span> History
          </a>
          <a href="#" class="nav-item" data-main-page="notification">
             <span class="nav-item-icon">üîî</span> Notification
          </a>
          <a href="#" class="nav-item" data-main-page="profile">
             <span class="nav-item-icon">üë§</span> Profile
          </a>
        </nav>

        <div class="nav-footer">
          <button class="logout-button" onclick="logout()">
            <span class="logout-text">Logout</span>
          </button>
        </div>
      </aside>

      <div class="content-container">
        
        <div class="main-section main-section-active" data-main-section="assignment">
          <aside class="activity-sidebar">
            <div class="activity-header">
              <div class="activity-icon">üìÑ</div>
              <h2 class="activity-title">Assignments</h2>
            </div>
        
            <div class="activity-filters">
              <button class="filter-btn filter-btn-active" data-filter="pending">
                <span class="filter-icon">‚è≥</span>
                <span class="filter-text">Pending</span>
                <span class="filter-count">0</span>
              </button>
              <button class="filter-btn" data-filter="ongoing">
                <span class="filter-icon">üîÑ</span>
                <span class="filter-text">Ongoing</span>
                <span class="filter-count">0</span>
              </button>
              <button class="filter-btn" data-filter="completed">
                <span class="filter-icon">‚úÖ</span>
                <span class="filter-text">Completed</span>
                <span class="filter-count">0</span>
              </button>
            </div>

            <div class="assignment-feed">
              <div class="feed-section feed-section-active" data-feed="pending">
                 </div>
              <div class="feed-section" data-feed="ongoing"></div>
              <div class="feed-section" data-feed="completed"></div>
            </div>
          </aside>

          <main class="main-content-area">
            <header class="main-header">
              <div class="header-nav"></div>
              <div class="header-actions" id="desktopPendingActions" style="display:none;">
                <button class="acknowledge-btn" onclick="acknowledgeAssignment()">
                  <span class="acknowledge-icon">‚úì</span>
                  <span>Acknowledge</span>
                </button>
              </div>
            </header>

            <div class="assignment-detail-view" id="desktopDetailView">
              <div style="text-align:center;color:#666;padding-top:40px;">Select an assignment to view details</div>
            </div>

            <div class="assignment-actions" id="desktopAssignmentActions" style="display: none; padding: 0 24px 24px;">
                <button id="desktopRequestMaterialBtn" class="action-btn action-secondary" onclick="requestMaterial()">Request Material</button>
                <button class="action-btn action-primary" onclick="markAsCompleted()">Mark as Completed</button>
            </div>
          </main>
        </div>

        <div class="main-section" data-main-section="history">
          <div class="section-wrapper">
            <header class="section-header">
              <h1 class="section-title">Assignment History</h1>
              <div class="history-filter">
                <label class="history-filter-label">Date</label>
                <select class="history-select" id="desktopHistoryDate">
                  <option value="all" selected>All</option>
                  <option value="today">Today</option>
                  <option value="yesterday">Yesterday</option>
                  <option value="older">Older</option>
                </select>
              </div>
            </header>
            <div class="section-content-area history-groups">
                </div>
          </div>
        </div>

        <div class="main-section" data-main-section="notification">
          <div class="section-wrapper">
            <header class="section-header">
              <h1 class="section-title">Notification</h1>
            </header>
            <div class="section-content-area notification-list-container">
                </div>
          </div>
        </div>

        <div class="main-section" data-main-section="profile">
          <div class="section-wrapper">
            <header class="section-header">
              <h1 class="section-title">Profile</h1>
            </header>
            <div class="section-content-area">
              <div class="profile-container">
                <div class="profile-main-card">
                  <div class="profile-card-header">
                    <div class="profile-avatar-large">
                      <span class="profile-initials-large">--</span>
                    </div>
                    <div class="profile-details">
                      <h2 class="profile-name-large">Loading...</h2>
                      <p class="profile-role-large">Field Engineer</p>
                      <p class="profile-email-large">...</p>
                    </div>
                  </div>
                  
                  <div class="profile-stats-grid">
                    <div class="profile-stat-card">
                      <div class="stat-number stat-total">0</div>
                      <div class="stat-label">Total Assignments</div>
                    </div>
                    <div class="profile-stat-card">
                      <div class="stat-number stat-completed">0</div>
                      <div class="stat-label">Completed</div>
                    </div>
                    <div class="profile-stat-card">
                      <div class="stat-number stat-rate">0%</div>
                      <div class="stat-label">Success Rate</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="acknowledgeModal" class="modal">
      <div class="modal-content">
        <h2 class="modal-title">Acknowledge</h2>
        <div class="modal-body">
          <label for="acknowledgeRemarks" class="modal-label">Remarks</label>
          <textarea id="acknowledgeRemarks" class="modal-textarea" placeholder="Enter remarks (optional)" rows="3"></textarea>
        </div>
        <div class="modal-actions">
          <button class="modal-btn modal-btn-cancel" onclick="closeAcknowledgeModal()">Cancel</button>
          <button class="modal-btn modal-btn-confirm" onclick="confirmAcknowledge()">Confirm</button>
        </div>
      </div>
    </div>

    <div id="requestVehicleModal" class="modal">
      <div class="modal-content">
        <h2 class="modal-title">Request Vehicle</h2>
        <div class="modal-body">
          <p class="modal-text">Request a vehicle to this location?</p>
          <div class="modal-field">
            <label class="modal-label">Assignment Site:</label>
            <p class="modal-location" id="vehReqSite">Loading...</p>
          </div>
          <label for="vehicleRemarks" class="modal-label">Remarks</label>
          <textarea id="vehicleRemarks" class="modal-textarea" placeholder="Enter remarks (optional)" rows="3"></textarea>
        </div>
        <div class="modal-actions">
          <button class="modal-btn modal-btn-cancel" onclick="closeRequestVehicleModal()">Cancel</button>
          <button class="modal-btn modal-btn-confirm" onclick="confirmRequestVehicle()">Confirm Request</button>
        </div>
      </div>
    </div>

    <div id="markCompletedModal" class="modal">
      <div class="modal-content">
        <h2 class="modal-title">Mark as Completed</h2>
        <div class="modal-body">
          <p class="modal-text">Add remarks before completing this assignment</p>
          <textarea id="markCompletedRemarks" class="modal-textarea" placeholder="Enter completion remarks..."></textarea>
        </div>
        <div class="modal-actions">
          <button class="modal-btn modal-btn-cancel" onclick="closeMarkCompletedModal()">Cancel</button>
          <button class="modal-btn modal-btn-confirm" onclick="confirmMarkCompleted()">Confirm</button>
        </div>
      </div>
    </div>

    <div id="materialRequestModal" class="modal">
      <div class="modal-content material-request">
        <h2 class="modal-title">Request Material</h2>
        <div class="modal-body">
          <div class="material-list" id="mrList"></div>
          <div style="display:flex;justify-content:flex-end;margin:8px 0;">
            <button type="button" class="add-material-btn" onclick="addMaterialRow()">+ Add Item</button>
          </div>
          <textarea id="mrRemarks" class="modal-textarea" style="margin-top:10px;" placeholder="Additional remarks..."></textarea>
        </div>
        <div class="modal-actions">
          <button class="modal-btn modal-btn-cancel" onclick="closeMaterialRequestModal()">Cancel</button>
          <button class="modal-btn modal-btn-confirm" onclick="confirmMaterialRequest()">Submit</button>
        </div>
      </div>
    </div>

    <div id="vehicleTicketModal" class="modal">
      <div class="modal-content vehicle-ticket">
        <h2 class="modal-title">Vehicle Ticket</h2>
        <div class="modal-body">
          <div class="vt-grid">
            <div class="vt-field"><label class="modal-label">Ticket Number</label><input id="vtTicket" class="modal-input" type="text" readonly /></div>
            <div class="vt-field"><label class="modal-label">Location</label><input id="vtLocation" class="modal-input" type="text" readonly /></div>
            <div class="vt-field"><label class="modal-label">Status</label><input id="vtStatus" class="modal-input" type="text" readonly /></div>
            <div class="vt-field"><label class="modal-label">Driver</label><input id="vtDriver" class="modal-input" type="text" readonly /></div>
            <div class="vt-field vt-span-2"><label class="modal-label">Remarks</label><input id="vtRemarks" class="modal-input" type="text" readonly /></div>
            <input type="hidden" id="vtPickup"><input type="hidden" id="vtPriority"><input type="hidden" id="vtContact"><input type="hidden" id="vtVehicle">
          </div>
        </div>
        <div class="modal-actions modal-actions-end">
          <button class="modal-btn modal-btn-confirm" onclick="closeVehicleTicketModal()">OK</button>
        </div>
      </div>
    </div>

    <div id="materialTicketModal" class="modal">
      <div class="modal-content material-ticket">
        <h2 class="modal-title">Material Request</h2>
        <div class="modal-body">
          <div class="material-grid">
            <div class="material-field"><label class="modal-label">Ticket</label><input id="mtTicket" class="modal-input" type="text" readonly /></div>
            <div class="material-field"><label class="modal-label">Status</label><input id="mtStatus" class="modal-input" type="text" readonly /></div>
            <div class="material-field"><label class="modal-label">Site</label><input id="mtSite" class="modal-input" type="text" readonly /></div>
            <div class="material-field vt-span-2"><label class="modal-label">Items</label><input id="mtItems" class="modal-input" type="text" readonly /></div>
            <div class="material-field vt-span-2"><label class="modal-label">Remarks</label><input id="mtRemarks" class="modal-input" type="text" readonly /></div>
            <input type="hidden" id="mtDatetime">
          </div>
        </div>
        <div class="modal-actions modal-actions-end">
          <button class="modal-btn modal-btn-confirm" onclick="closeMaterialTicketModal()">OK</button>
        </div>
      </div>
    </div>

    <div id="successToast" class="toast">
      <span class="toast-text">Action Successful</span>
    </div>

    <script>
      // Supabase Configuration
      const SUPABASE_URL = 'https://bicvcqolkaokimtwimhn.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpY3ZjcW9sa2Fva2ltdHdpbWhuIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MjUzMDIwMCwiZXhwIjoyMDc4MTA2MjAwfQ.eAYHk5c53gz5y2r85Rkz_-48taKCZWii-5cR2glCMP0';
      
      let supabase;
      let currentUser = null;
      let assignmentsData = [];
      let notificationsData = { materials: [], vehicles: [] };
      let currentAssignmentId = null;

      if (window.supabase) {
          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      }

      document.addEventListener("DOMContentLoaded", async () => {
          if (!supabase) { console.error("Supabase not loaded"); return; }

          // Check Auth
          const { data: { session } } = await supabase.auth.getSession();
          if (!session) {
              window.location.href = '../login/login.html';
              return;
          }
          currentUser = session.user;

          // Initialization
          initNavigation();
          initTabs();
          initFilters();
          
          // Data Loading
          loadUserProfile();
          fetchDashboardData(); 
      });

      // --- NAVIGATION ---
      function initNavigation() {
          const navLinks = document.querySelectorAll(".main-navigation a.nav-item"); 
          const mainSections = document.querySelectorAll(".main-section"); 
          
          navLinks.forEach((link) => {
              link.addEventListener("click", (e) => {
                  e.preventDefault();
                  const targetPage = link.getAttribute("data-main-page"); 
                  
                  navLinks.forEach(l => l.classList.remove("nav-item-active"));
                  link.classList.add("nav-item-active");
                  
                  mainSections.forEach(s => {
                      s.classList.remove("main-section-active");
                      if (s.getAttribute("data-main-section") === targetPage) { 
                          s.classList.add("main-section-active");
                      }
                  });
              });
          });

          // Mobile Bottom Navigation
          const mobileNavButtons = document.querySelectorAll(".bottom-nav .nav-item");
          const mobileSections = document.querySelectorAll(".mobile-content-section");
          
          mobileNavButtons.forEach((btn) => {
              btn.addEventListener("click", () => {
                  const targetPage = btn.getAttribute("data-mobile-page");
                  mobileNavButtons.forEach(b => b.classList.remove("nav-item-active"));
                  btn.classList.add("nav-item-active");
                  mobileSections.forEach(s => {
                      s.classList.remove("mobile-content-section-active");
                      if (s.getAttribute("data-mobile-content") === targetPage) {
                          s.classList.add("mobile-content-section-active");
                      }
                  });
              });
          });
      }

      function initTabs() {
          const tabs = document.querySelectorAll(".tab");
          const filters = document.querySelectorAll(".filter-btn"); 
          const containers = document.querySelectorAll(".task-container");
          const feeds = document.querySelectorAll(".feed-section");

          // Mobile Tabs Logic
          tabs.forEach(t => {
              t.addEventListener("click", () => {
                  tabs.forEach(x => x.classList.remove("tab-active"));
                  t.classList.add("tab-active");
                  const target = t.getAttribute("data-tab");
                  containers.forEach(c => {
                      c.classList.remove("task-container-active");
                      if (c.getAttribute("data-container") === target) {
                          c.classList.add("task-container-active");
                      }
                  });
              });
          });

          // Desktop Filters Logic
          filters.forEach(btn => {
              btn.addEventListener("click", () => {
                  filters.forEach(b => b.classList.remove("filter-btn-active"));
                  btn.classList.add("filter-btn-active");
                  const target = btn.getAttribute("data-filter");
                  feeds.forEach(f => {
                      f.classList.remove("feed-section-active");
                      if (f.getAttribute("data-feed") === target) {
                          f.classList.add("feed-section-active");
                      }
                  });
              });
          });
      }

      function initFilters() {
          const mFilter = document.getElementById('mobileHistoryDate');
          const dFilter = document.getElementById('desktopHistoryDate');
          
          if(mFilter) mFilter.addEventListener('change', (e) => renderHistory(assignmentsData, e.target.value));
          if(dFilter) dFilter.addEventListener('change', (e) => renderHistory(assignmentsData, e.target.value));
      }

      // --- DATA LOADING ---
      async function loadUserProfile() {
          const { data } = await supabase
              .from('engineer_records')
              .select('*')
              .eq('user_id', currentUser.id)
              .single();
          
          if (data) {
              const fullName = `${data.firstName} ${data.lastName}`;
              document.querySelectorAll('.profile-name, .profile-name-large, .mobile-profile-name, .hero-subtitle').forEach(el => el.textContent = fullName);
              document.querySelectorAll('.profile-email, .profile-email-large, .mobile-profile-email').forEach(el => el.textContent = data.email);
              document.querySelectorAll('.profile-initials, .profile-initials-large, .mobile-profile-initials').forEach(el => el.textContent = (data.firstName[0] + data.lastName[0]).toUpperCase());
          }
      }

      async function fetchDashboardData() {
          const { data: { session } } = await supabase.auth.getSession();
          try {
              const response = await fetch('http://localhost:3000/api/engineer/dashboard-data', {
                  headers: { 'Authorization': `Bearer ${session.access_token}` }
              });
              if (!response.ok) throw new Error('Failed to fetch data');
              
              const result = await response.json();
              assignmentsData = result.assignments || [];
              notificationsData = result.notifications || { materials: [], vehicles: [] };
              
              renderAssignments(assignmentsData);
              renderHistory(assignmentsData, 'all');
              renderNotifications(assignmentsData, notificationsData); 
              updateStats(assignmentsData); 
              
          } catch (error) { 
              console.error("Error:", error);
          }
      }

      // --- RENDERING ---
      function renderAssignments(data) {
          const cats = ['pending', 'ongoing', 'completed'];
          
          // Clear previous
          cats.forEach(c => {
              const mCont = document.querySelector(`.task-container[data-container="${c}"]`);
              const dCont = document.querySelector(`.feed-section[data-feed="${c}"]`);
              if(mCont) mCont.innerHTML = '';
              if(dCont) dCont.innerHTML = '';
          });

          data.forEach(item => {
              const s = (item.status || '').toLowerCase();
              let cat = 'pending';
              // FIXED: Added 'acknowledged' and 'in_progress' to the conditional check for ongoing
              if (['in progress', 'ongoing', 'accepted', 'acknowledged', 'in_progress'].includes(s)) cat = 'ongoing';
              else if (['completed', 'done'].includes(s)) cat = 'completed';
              else if (['pending', 'assigned'].includes(s)) cat = 'pending';
              else return; // Skip if status is unknown, to prevent showing in pending by default
              
              const dateStr = new Date(item.date).toLocaleDateString();
              const priority = item.priority_level || 'Medium';
              const priorityClass = priority.toLowerCase() === 'high' ? 'priority-high' : 'priority-medium';

              // Mobile Card Template
              const mCard = `
                <article class="assignment-card" onclick="openAssignmentDetails(${item.id})">
                  <div class="assignment-card-header">
                    <div class="assignment-title">${item.type_of_appointment}</div>
                    <div class="assignment-priority ${priorityClass}">${priority}</div>
                  </div>
                  <div class="assignment-location">Site: ${item.site}</div>
                  <div class="assignment-due-label">${cat === 'completed' ? 'Completed' : 'Due'}: ${dateStr}</div>
                  <div class="assignment-progress assignment-progress-${priority.toLowerCase() === 'high' ? 'high' : 'medium'}"></div>
                </article>`;
              
              // Desktop Feed Item Template
              let icon = 'üìã';
              if(item.type_of_appointment.includes('Inspection')) icon = 'üìç';
              if(item.type_of_appointment.includes('Installation')) icon = 'üîß';
              if(item.type_of_appointment.includes('Maintenance')) icon = 'üåê';

              const dCard = `
                <div class="assignment-item" onclick="selectAssignment(${item.id})">
                  <div class="assignment-avatar">
                    <span class="assignment-icon">${icon}</span>
                  </div>
                  <div class="assignment-info">
                    <div class="assignment-name">${item.type_of_appointment}</div>
                    <div class="assignment-location">${item.site}</div>
                    <div class="assignment-time">${cat === 'completed' ? 'Completed' : 'Due'}: ${dateStr}</div>
                  </div>
                </div>`;

              const mCont = document.querySelector(`.task-container[data-container="${cat}"]`);
              const dCont = document.querySelector(`.feed-section[data-feed="${cat}"]`);
              
              if(mCont) mCont.innerHTML += mCard;
              if(dCont) dCont.innerHTML += dCard;
          });

          // Empty States
          cats.forEach(c => {
              const mCont = document.querySelector(`.task-container[data-container="${c}"]`);
              if(mCont && mCont.innerHTML === '') mCont.innerHTML = '<p style="text-align:center;padding:20px;color:#999;">No assignments.</p>';
              
              const dCont = document.querySelector(`.feed-section[data-feed="${c}"]`);
              if(dCont && dCont.innerHTML === '') dCont.innerHTML = '<p style="text-align:center;padding:20px;color:#999;">No assignments.</p>';
          });
      }

      function renderHistory(data, filter = 'all') {
          let completed = data.filter(a => ['completed','done'].includes((a.status||'').toLowerCase()));
          
          if(filter !== 'all') {
              const now = new Date();
              const yesterday = new Date(now); yesterday.setDate(yesterday.getDate() - 1);
              
              completed = completed.filter(item => {
                  const d = new Date(item.completed_at || item.date);
                  if(filter === 'today') return d.toDateString() === now.toDateString();
                  if(filter === 'yesterday') return d.toDateString() === yesterday.toDateString();
                  if(filter === 'older') return d < yesterday;
                  return true;
              });
          }

          const generateHtml = (items, isMobile) => {
              if(items.length === 0) return '<p style="padding:20px; text-align:center;">No history found.</p>';
              
              let html = '';
              const grouped = items.reduce((acc, i) => {
                  const d = new Date(i.completed_at || i.date).toLocaleDateString();
                  const now = new Date().toLocaleDateString();
                  const yester = new Date(new Date().setDate(new Date().getDate()-1)).toLocaleDateString();
                  
                  let k = 'Others';
                  if(d === now) k = 'Today';
                  else if(d === yester) k = 'Yesterday';
                  
                  if(!acc[k]) acc[k] = [];
                  acc[k].push(i);
                  return acc;
              }, {});

              const groupOrder = ['Today', 'Yesterday', 'Others'];
              
              groupOrder.forEach(key => {
                  if(grouped[key]) {
                      if(isMobile) {
                          html += `<div class="mobile-history-group"><div class="mobile-history-group-title">${key}</div>`;
                          grouped[key].forEach(i => {
                              let icon = 'üîß';
                              if(i.type_of_appointment.includes('Inspection')) icon = 'üìç';
                              else if(i.type_of_appointment.includes('Maintenance')) icon = 'üåê';

                              html += `
                              <div class="mobile-history-card">
                                <div class="mobile-history-icon">${icon}</div>
                                <div class="mobile-history-info">
                                  <h3>${i.type_of_appointment} - ${i.site}</h3>
                                  <p class="history-sub">Ticket #${i.ticket_code || 'N/A'}</p>
                                  <p class="history-meta">Completed ¬∑ ${new Date(i.date).toLocaleDateString()}</p>
                                </div>
                              </div>`;
                          });
                          html += `</div>`;
                      } else {
                          html += `<div class="history-group"><div class="history-group-title">${key}</div><div class="history-list">`;
                          grouped[key].forEach(i => {
                              let icon = 'üîß';
                              if(i.type_of_appointment.includes('Inspection')) icon = 'üìç';
                              else if(i.type_of_appointment.includes('Maintenance')) icon = 'üåê';

                              html += `
                              <div class="history-list-item">
                                <div class="history-item-icon">${icon}</div>
                                <div class="history-item-body">
                                  <h3 class="history-title">${i.type_of_appointment} - ${i.site}</h3>
                                  <p class="history-sub">Ticket #${i.ticket_code}</p>
                                  <p class="history-meta">Completed on ${new Date(i.date).toLocaleDateString()}</p>
                                </div>
                                <span class="chip chip-completed">Completed</span>
                              </div>`;
                          });
                          html += `</div></div>`;
                      }
                  }
              });
              return html;
          };

          const mHist = document.querySelector('.mobile-history-list-container');
          const dHist = document.querySelector('.main-section[data-main-section="history"] .history-groups');
          
          if(mHist) mHist.innerHTML = generateHtml(completed, true);
          if(dHist) dHist.innerHTML = generateHtml(completed, false);
      }

      function renderNotifications(assignments, notifications) {
          let allItems = [];
          assignments.filter(a => (a.status||'').toLowerCase() === 'assigned').forEach(a => {
              allItems.push({ type:'new', title:'New Assignment', msg:`${a.type_of_appointment} at ${a.site}`, time:a.created_at, id:a.id });
          });
          notifications.materials.forEach(m => {
              allItems.push({ type:'mat', title:`Material ${m.status}`, msg:`Ticket ${m.ticket_id}`, time:m.updated_at, id:m.ticket_id, status:m.status });
          });
          notifications.vehicles.forEach(v => {
              allItems.push({ type:'veh', title:`Vehicle ${v.status}`, msg:`Ticket ${v.ticket_id}`, time:v.updated_at, id:v.ticket_id, status:v.status });
          });

          allItems.sort((a, b) => new Date(b.time) - new Date(a.time));

          const generateHtml = (items, isMobile) => {
              if(items.length === 0) return '<p style="padding:20px; text-align:center;">No notifications.</p>';
              let html = '';
              const grouped = items.reduce((acc, i) => {
                  const d = new Date(i.time).toLocaleDateString();
                  const n = new Date().toLocaleDateString();
                  const k = d === n ? 'Today' : 'Earlier';
                  if(!acc[k]) acc[k] = [];
                  acc[k].push(i);
                  return acc;
              }, {});

              Object.keys(grouped).forEach(key => {
                  if(isMobile) html += `<div class="notif-section"><div class="notif-section-title">${key}</div>`;
                  else html += `<div class="notification-group"><div class="notif-desktop-title">${key}</div><div class="notification-grid">`;

                  grouped[key].forEach(item => {
                      let icon = 'üîî';
                      let clickFn = '';
                      if(item.type === 'mat') { icon = 'üì¶'; clickFn = `openMaterialTicketModal('${item.id}', '${item.status}')`; }
                      else if(item.type === 'veh') { icon = 'üöó'; clickFn = `openVehicleTicketModal('${item.id}', '${item.status}')`; }
                      else { clickFn = `openAssignmentDetails(${item.id})`; }

                      if(isMobile) {
                          html += `
                          <button class="notif-card" type="button" onclick="${clickFn}">
                            <span class="notif-icon">${icon}</span>
                            <div class="notif-body">
                              <div class="notif-card-title">${item.title}</div>
                              <div class="notif-sub">${item.msg}</div>
                              <div class="notif-time">${new Date(item.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                            </div>
                          </button>`;
                      } else {
                          html += `
                          <div class="notification-card" onclick="${clickFn}">
                            <div class="notification-card-header">
                              <div class="notification-icon"><span class="notification-icon-symbol">${icon}</span></div>
                              <div class="notification-info">
                                <h3 class="notification-title">${item.title}</h3>
                                <p class="notification-message">${item.msg}</p>
                                <p class="notification-time">${new Date(item.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</p>
                              </div>
                            </div>
                          </div>`;
                      }
                  });
                  
                  if(isMobile) html += `</div>`;
                  else html += `</div></div>`;
              });
              return html;
          };

          const mCont = document.querySelector('.mobile-notification-list-container');
          const dCont = document.querySelector('.notification-list-container');
          if(mCont) mCont.innerHTML = generateHtml(allItems, true);
          if(dCont) dCont.innerHTML = generateHtml(allItems, false);
      }

      function updateStats(data) {
          const total = data.length;
          const completed = data.filter(i => (i.status||'').toLowerCase() === 'completed').length;
          const pending = data.filter(i => ['pending','assigned'].includes((i.status||'').toLowerCase())).length;
          // FIXED: Added 'acknowledged' and 'in_progress' to counting logic
          const ongoing = data.filter(i => ['in progress','ongoing','accepted', 'acknowledged', 'in_progress'].includes((i.status||'').toLowerCase())).length;
          const rate = total > 0 ? Math.round((completed/total)*100) + '%' : '0%';

          const pCount = document.querySelector('.filter-btn[data-filter="pending"] .filter-count');
          if(pCount) pCount.textContent = pending;
          
          const oCount = document.querySelector('.filter-btn[data-filter="ongoing"] .filter-count');
          if(oCount) oCount.textContent = ongoing;
          
          const cCount = document.querySelector('.filter-btn[data-filter="completed"] .filter-count');
          if(cCount) cCount.textContent = completed;

          document.querySelectorAll('.stat-total').forEach(el => el.textContent = total);
          document.querySelectorAll('.stat-completed').forEach(el => el.textContent = completed);
          document.querySelectorAll('.stat-rate').forEach(el => el.textContent = rate);
      }

      function getAssignment(id) { return assignmentsData.find(a => a.id == id); }

      // Helper to check if material requested
      function hasMaterialRequest(ticketCode) {
         // Checks the loaded notifications to see if a material request exists for this ticket
         return notificationsData.materials.some(m => m.ticket_code === ticketCode || m.ticket_id === ticketCode);
      }

      // --- DETAILS VIEW ---
      window.selectAssignment = function(id) {
          currentAssignmentId = id;
          const item = getAssignment(id);
          if(!item) return;

          document.querySelectorAll('.assignment-item').forEach(el => el.classList.remove('selected'));
          const selectedItem = document.querySelector(`.assignment-feed .feed-section-active`).querySelector(`[onclick="selectAssignment(${id})"]`);
          if(selectedItem) selectedItem.classList.add('selected');
          
          const container = document.getElementById('desktopDetailView');
          const status = (item.status||'').toLowerCase();
          
          container.innerHTML = `
            <div class="assignment-detail-header">
                <h1 class="assignment-detail-title">${item.type_of_appointment}</h1>
                <span class="assignment-detail-priority priority-medium">${item.priority_level || 'MEDIUM'}</span>
            </div>
            <div class="assignment-detail-meta">
                <p class="assignment-detail-site">Site: ${item.site}</p>
                <p class="assignment-detail-due">Due: ${new Date(item.date).toLocaleDateString()}</p>
            </div>
            <div class="assignment-sections">
                <div class="section-content">
                    <div class="details-grid">
                        <div class="detail-card"><div class="detail-label">TICKET NUMBER</div><div class="detail-value">${item.ticket_code || 'N/A'}</div></div>
                        <div class="detail-card"><div class="detail-label">DATE & TIME</div><div class="detail-value">${new Date(item.date).toLocaleString()}</div></div>
                        <div class="detail-card"><div class="detail-label">PRIORITY</div><div class="detail-value">${item.priority_level || 'N/A'}</div></div>
                        <div class="detail-card"><div class="detail-label">TYPE</div><div class="detail-value">${item.type_of_appointment}</div></div>
                        <div class="detail-card detail-card-full"><div class="detail-label">DESCRIPTION</div><div class="detail-value">${item.task_description || 'N/A'}</div></div>
                        <div class="detail-card detail-card-full"><div class="detail-label">REMARKS</div><div class="detail-value">${item.pm_remarks || 'None'}</div></div>
                    </div>
                </div>
            </div>`;

          const pendingActions = document.getElementById('desktopPendingActions');
          const ongoingActions = document.getElementById('desktopAssignmentActions');
          
          pendingActions.style.display = 'none';
          ongoingActions.style.display = 'none';

          if(['pending','assigned'].includes(status)) {
              pendingActions.style.display = 'flex';
          } else if(['in progress','ongoing','accepted', 'acknowledged', 'in_progress'].includes(status)) {
              ongoingActions.style.display = 'flex';
              
              // Check Material Request Status for Desktop
              const matBtn = document.getElementById('desktopRequestMaterialBtn');
              if(hasMaterialRequest(item.ticket_code)) {
                  matBtn.textContent = 'Material Requested';
                  matBtn.classList.add('btn-requested');
              } else {
                  matBtn.textContent = 'Request Material';
                  matBtn.classList.remove('btn-requested');
              }
          }
      };

      window.openAssignmentDetails = function(id) {
          currentAssignmentId = id;
          const item = getAssignment(id);
          if(!item) return;

          document.getElementById('mTitle').textContent = item.type_of_appointment;
          document.getElementById('mSite').textContent = `Site: ${item.site}`;
          document.getElementById('mDue').textContent = `Due: ${new Date(item.date).toLocaleDateString()}`;
          document.getElementById('mTicket').textContent = item.ticket_code || 'N/A';
          document.getElementById('mDateTime').textContent = new Date(item.date).toLocaleString();
          document.getElementById('mPriority').textContent = item.priority_level || 'Medium';
          document.getElementById('mType').textContent = item.type_of_appointment;
          document.getElementById('mDescription').textContent = item.task_description || 'N/A';
          document.getElementById('mRemarks').textContent = item.pm_remarks || 'None';

          const status = (item.status||'').toLowerCase();
          const isOngoing = ['in progress','ongoing','accepted', 'acknowledged', 'in_progress'].includes(status);
          const isPending = ['pending','assigned'].includes(status);

          document.getElementById('mobileActionBtn').style.display = isPending ? 'block' : 'none';
          
          const matBtn = document.getElementById('mobileRequestMaterialBtn');
          matBtn.style.display = isOngoing ? 'block' : 'none';
          
          // Check Material Request Status for Mobile
          if(isOngoing && hasMaterialRequest(item.ticket_code)) {
              matBtn.textContent = 'Material Requested';
              matBtn.classList.add('btn-requested');
          } else {
              matBtn.textContent = 'REQUEST MATERIAL';
              matBtn.classList.remove('btn-requested');
          }

          document.getElementById('mobileRequestVehicleBtn').style.display = isOngoing ? 'block' : 'none';
          document.getElementById('mobileMarkCompletedBtn').style.display = isOngoing ? 'block' : 'none';

          document.getElementById('mobileAssignmentDetails').classList.add('show');
      };

      window.closeMobileAssignmentDetails = function() {
          document.getElementById('mobileAssignmentDetails').classList.remove('show');
      };

      // --- ACTION LOGIC ---
      window.acknowledgeAssignment = function() { document.getElementById('acknowledgeModal').classList.add('show'); };
      window.closeAcknowledgeModal = function() { document.getElementById('acknowledgeModal').classList.remove('show'); };
      
      window.confirmAcknowledge = async function() {
          if(!currentAssignmentId) return;
          const remarks = document.getElementById('acknowledgeRemarks').value;
          try {
              await fetch('http://localhost:3000/api/engineer/acknowledge', {
                  method:'POST', headers:{'Content-Type':'application/json'},
                  body: JSON.stringify({ appointment_id: currentAssignmentId, remarks })
              });
              closeAcknowledgeModal();
              closeMobileAssignmentDetails();
              fetchDashboardData();
              showToast('Acknowledged');

              // Automatically open vehicle request upon acknowledgment
              setTimeout(() => {
                  requestVehicle();
              }, 300);

          } catch(e) { alert(e.message); }
      };

      window.requestMaterial = function() {
          const btn = document.getElementById('desktopRequestMaterialBtn');
          if(btn.classList.contains('btn-requested')) return; // Check if already requested

          document.getElementById('materialRequestModal').classList.add('show');
          document.getElementById('mrList').innerHTML = '';
          addMaterialRow();
      };
      window.closeMaterialRequestModal = function() { document.getElementById('materialRequestModal').classList.remove('show'); };
      
      window.addMaterialRow = function() {
          const div = document.createElement('div');
          div.className = 'mr-row';
          div.innerHTML = `
              <input class="modal-input mr-type" placeholder="Item">
              <input class="modal-input mr-qty" type="number" placeholder="Qty" style="width:80px;">
              <button class="remove-material-btn" onclick="this.parentElement.remove()">√ó</button>`;
          document.getElementById('mrList').appendChild(div);
      };

      window.confirmMaterialRequest = async function() {
          const item = getAssignment(currentAssignmentId);
          const rows = document.querySelectorAll('#mrList .mr-row');
          const materials = Array.from(rows).map(r => ({
              type: r.querySelector('.mr-type').value,
              qty: r.querySelector('.mr-qty').value
          })).filter(m => m.type);
          
          try {
              await fetch('http://localhost:3000/api/engineer/request-material', {
                  method:'POST', headers:{'Content-Type':'application/json'},
                  body: JSON.stringify({ ticket_code: item.ticket_code, site: item.site, materials, remarks: document.getElementById('mrRemarks').value })
              });
              
              closeMaterialRequestModal();
              showToast('Material Request Sent');

              // --- UPDATE UI IMMEDIATELY ---
              // Update local data to reflect this so navigation doesn't reset it
              notificationsData.materials.push({ ticket_code: item.ticket_code, status: 'Pending' });

              // Update Desktop Button
              const dBtn = document.getElementById('desktopRequestMaterialBtn');
              if(dBtn) {
                  dBtn.textContent = 'Material Requested';
                  dBtn.classList.add('btn-requested');
              }

              // Update Mobile Button
              const mBtn = document.getElementById('mobileRequestMaterialBtn');
              if(mBtn) {
                  mBtn.textContent = 'Material Requested';
                  mBtn.classList.add('btn-requested');
              }

          } catch(e) { alert(e.message); }
      };

      window.requestVehicle = function() {
          const item = getAssignment(currentAssignmentId);
          if(!item) return alert("Select assignment");
          document.getElementById('vehReqSite').textContent = item.site;
          document.getElementById('requestVehicleModal').classList.add('show');
      };
      window.closeRequestVehicleModal = function() { document.getElementById('requestVehicleModal').classList.remove('show'); };
      
      window.confirmRequestVehicle = async function() {
          const item = getAssignment(currentAssignmentId);
          const remarks = document.getElementById('vehicleRemarks').value;
          try {
              await fetch('http://localhost:3000/api/engineer/request-vehicle', {
                  method:'POST', headers:{'Content-Type':'application/json'},
                  body: JSON.stringify({ ticket_code: item.ticket_code, location: item.site, remarks, requested_by: currentUser.email })
              });
              closeRequestVehicleModal();
              showToast('Vehicle Requested');
          } catch(e) { alert(e.message); }
      };

      window.markAsCompleted = function() {
          if(!currentAssignmentId) return alert("Select assignment");
          document.getElementById('markCompletedModal').classList.add('show');
      };
      window.closeMarkCompletedModal = function() { document.getElementById('markCompletedModal').classList.remove('show'); };
      
      window.confirmMarkCompleted = async function() {
          const remarks = document.getElementById('markCompletedRemarks').value;
          try {
              await fetch('http://localhost:3000/api/engineer/complete', {
                  method:'POST', headers:{'Content-Type':'application/json'},
                  body: JSON.stringify({ appointment_id: currentAssignmentId, remarks })
              });
              closeMarkCompletedModal();
              closeMobileAssignmentDetails();
              fetchDashboardData();
              showToast('Completed');
          } catch(e) { alert(e.message); }
      };

      window.openVehicleTicketModal = function(id, status) {
          const ticket = notificationsData.vehicles.find(v => v.ticket_id === id);
          if(!ticket) return;
          document.getElementById('vtTicket').value = ticket.ticket_id;
          document.getElementById('vtLocation').value = ticket.location;
          document.getElementById('vtStatus').value = ticket.status;
          document.getElementById('vtDriver').value = ticket.driver_name || 'N/A';
          document.getElementById('vtRemarks').value = ticket.remarks || '';
          document.getElementById('vehicleTicketModal').classList.add('show');
      };
      window.closeVehicleTicketModal = function() { document.getElementById('vehicleTicketModal').classList.remove('show'); };

      window.openMaterialTicketModal = function(id, status) {
          const ticket = notificationsData.materials.find(m => m.ticket_id === id);
          if(!ticket) return;
          document.getElementById('mtTicket').value = ticket.ticket_id;
          document.getElementById('mtSite').value = ticket.site;
          document.getElementById('mtStatus').value = ticket.status;
          document.getElementById('mtItems').value = JSON.stringify(ticket.items || []);
          document.getElementById('mtRemarks').value = ticket.remarks || '';
          document.getElementById('materialTicketModal').classList.add('show');
      };
      window.closeMaterialTicketModal = function() { document.getElementById('materialTicketModal').classList.remove('show'); };

      window.showToast = function(msg) {
          const t = document.getElementById('successToast');
          t.querySelector('.toast-text').textContent = msg;
          t.classList.add('show');
          setTimeout(() => t.classList.remove('show'), 3000);
      };

      window.logout = function() {
          supabase.auth.signOut();
          window.location.href = '../login/login.html';
      };
    </script>
  </body>
</html>