<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FINSI — Status</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="status.css">
    <style>
        /* (Your existing styles are all perfect) */
        :root { --brand-700:#0a3cff; --brand-600:#155bff; --accent-500:#22d3ee; --text-900:#0b1020; --text-700:#2a3347; --text-500:#66748a; --bg-50:#f6f8ff; --white:#ffffff; }
        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body { margin:0; font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:var(--text-900); background: radial-gradient(1200px 600px at 80% -20%, #e8efff, transparent 60%), var(--bg-50); display:flex; flex-direction:column; min-height:100vh; }
        main { flex:1; }
        .container { width:100%; max-width:1200px; margin:0 auto; padding:0 20px; }
        header { position:sticky; top:0; z-index:50; background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); border-bottom:1px solid #e6ecf7; }
        .nav { display:flex; align-items:center; justify-content:space-between; height:80px; }
        .brand { display:inline-flex; align-items:center; gap:10px; font-weight:800; font-size:24px; letter-spacing:.4px; }
        nav ul { display:flex; align-items:center; gap:28px; list-style:none; margin:0; padding:0; }
        nav a { color:var(--text-700); font-weight:700; font-size:18px; position:relative; padding:8px 2px; text-decoration:none; }
        nav a:hover { color:var(--brand-600); }
        .badge { font-size:11px; padding:2px 8px; border-radius:999px; font-weight:800; }
        .badge.pending { background: rgba(245,158,11,0.15); color:#b45309; }
        .badge.approved { background: rgba(16,185,129,0.15); color:#065f46; }
        .profile { position:relative; }
        .profile-btn { background:#fff; border:1px solid #e6ecf7; border-radius:999px; padding:8px 12px; font-weight:700; color:var(--text-700); display:inline-flex; align-items:center; gap:8px; cursor:pointer; box-shadow:0 6px 16px rgba(11,92,255,0.08); }
        .profile-dropdown { position:absolute; right:0; top:calc(100% + 8px); background:#fff; border:1px solid #e6ecf7; border-radius:12px; min-width:200px; box-shadow:0 16px 30px rgba(21,91,255,0.12); display:none; overflow:hidden; z-index:100; }
        .profile-dropdown.open { display:grid; }
        .profile-dropdown a, .profile-dropdown button { padding:10px 14px; text-align:left; border:0; background:none; font:inherit; color:var(--text-700); cursor:pointer; }
        .profile-dropdown a:hover, .profile-dropdown button:hover { background:#f6f8ff; color:#0a3cff; }
        .page-hero { padding:18px 0 6px; }
        h1 { font-size:32px; margin:6px 0; }
        .sub { color:var(--text-500); }
        .card { background:#fff; border:1px solid #e6ecf7; border-radius:14px; padding:16px; box-shadow:0 8px 18px rgba(11,92,255,0.06); }
        .table { width:100%; border-collapse:collapse; }
        .table th, .table td { padding:12px 14px; text-align:left; border-bottom:1px solid #eef2ff; font-size:14px; }
        .table th { background:#0a3cff; color:#fff; font-weight:800; }
        .status-pill { display:inline-block; font-size:12px; padding:2px 8px; border-radius:999px; font-weight:800; }
        .status-pending { background:rgba(245,158,11,.12); color:#b45309; }
        .status-approved { background:rgba(16,185,129,.12); color:#065f46; }
        .status-rejected { background:rgba(239,68,68,.12); color:#991b1b; }
        .status-assigned { background:rgba(59,130,246,.12); color:#1d4ed8; }
        .status-inprogress { background:rgba(124,58,237,.12); color:#6d28d9; }
        .status-done { background:rgba(34,197,94,.12); color:#15803d; }
        .filter-bar { display:flex; gap:12px; align-items:center; margin-bottom:16px; }
        .filter-bar label { font-weight:700; color:var(--text-700); }
        .filter-bar select { padding:8px 12px; border:1px solid #e6ecf7; border-radius:8px; font:inherit; color:var(--text-700); background:#fff; cursor:pointer; }
        .footer { padding:34px 0; border-top:1px solid #e6ecf7; background:#fbfdff; color:var(--text-500); }
        .btn-view { background:#155bff; color:#fff; border:none; padding:8px 16px; border-radius:8px; font-weight:600; font-size:13px; cursor:pointer; transition:all 0.2s; }
        .btn-view:hover { background:#0a3cff; transform:translateY(-1px); box-shadow:0 4px 12px rgba(10,60,255,0.3); }
        .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(11,16,32,0.7); backdrop-filter:blur(4px); }
        .modal.show { display:flex; align-items:center; justify-content:center; }
        .modal-content { background:#fff; border-radius:16px; padding:32px; max-width:600px; width:90%; max-height:85vh; overflow-y:auto; box-shadow:0 20px 60px rgba(10,60,255,0.25); animation:modalSlideIn 0.3s ease-out; }
        @keyframes modalSlideIn { from { opacity:0; transform:translateY(-20px); } to { opacity:1; transform:translateY(0); } }
        .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; padding-bottom:16px; border-bottom:2px solid #e6ecf7; }
        .modal-header h2 { margin:0; font-size:24px; color:var(--brand-700); }
        .close-btn { background:none; border:none; font-size:28px; color:var(--text-500); cursor:pointer; width:36px; height:36px; display:flex; align-items:center; justify-content:center; border-radius:8px; transition:all 0.2s; }
        .close-btn:hover { background:#f6f8ff; color:var(--brand-700); }
        .detail-row { display:grid; grid-template-columns:140px 1fr; gap:12px; padding:12px 0; border-bottom:1px solid #eef2ff; }
        .detail-row:last-child { border-bottom:none; }
        .detail-label { font-weight:700; color:var(--text-700); }
        .detail-value { color:var(--text-900); }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabaseClient.js"></script>
    <script>
        // ---
        // ================================================================
        // NEW AUTHENTICATION & DATA SCRIPT
        // ================================================================
        // ---

        // Global variables
        let currentUser = null;
        let userProfile = null;
        let allAppointments = []; // Holds all loaded appointments

        // Helper function for status pills (from your original file)
        function statusClass(s){
            const k = String(s||'pending').toLowerCase();
            if (k === 'approved') return 'status-approved';
            if (k === 'rejected') return 'status-rejected';
            if (k === 'assigned') return 'status-assigned';
            if (k === 'ongoing' || k === 'in progress' || k === 'in_progress') return 'status-inprogress';
            if (k === 'completed' || k === 'done') return 'status-done';
            return 'status-pending'; // Default
        }
        
        // NEW: Real Logout function
        async function logout(){ 
            const { error } = await supabase.auth.signOut();
            if (error) console.error('Error logging out:', error.message);
            window.location.href = 'landingpage.html#home'; 
        }

        // NEW: Check user session on page load
        async function checkUserSession() {
            const { data, error } = await supabase.auth.getSession();
            if (error || !data.session) {
                console.log('No session found, redirecting to login.');
                window.location.href = 'login.html'; // Redirect if no session
                return;
            }

            // Session exists, store the user
            currentUser = data.session.user;

            // Now, get the user's profile
            const { data: profile, error: profileError } = await supabase
                .from('facility_owner_records')
                .select('*')
                .eq('user_id', currentUser.id)
                .single();

            if (profileError) {
                console.error('Error fetching profile:', profileError.message);
                logout(); // Profile not found, log out
                return;
            }

            userProfile = profile;
            updateHeaderUI();
            
            // Now that we have a user, load their appointments
            loadAndRenderAppointments();
        }
        
        // NEW: Function to update the header
        function updateHeaderUI() {
            const label = document.getElementById('welcomeLabel');
            if (label && userProfile) {
                label.textContent = userProfile.company_name || userProfile.email;
            }
            
            var badge = document.querySelector('.profile-btn .badge');
            if (badge) {
                // We'll just set to 'approved' since registration is automatic
                badge.textContent = 'Approved';
                badge.classList.remove('pending');
                badge.classList.add('approved');
            }
        }

        // NEW: Function to load appointments from Supabase
        async function loadAndRenderAppointments() {
            const tableBody = document.getElementById('statusBody');
            if (!tableBody) return;

            tableBody.innerHTML = `<tr><td colspan="9" style="text-align: center;">Loading your appointments...</td></tr>`;

            // Fetch appointments. RLS policy ensures we only get our own.
            const { data, error } = await supabase
                .from('appointment_records')
                .select('*') // Get all columns
                .order('created_at', { ascending: false }); // Show newest first

            if (error) {
                console.error('Error fetching appointments:', error.message);
                tableBody.innerHTML = `<tr><td colspan="9" style="text-align: center; color: red;">Error loading appointments.</td></tr>`;
                return;
            }

            allAppointments = data; // Save data globally for the modal
            renderTable(allAppointments);
        }

        // NEW: Function to render the table rows from data
        function renderTable(appointments) {
            const tableBody = document.getElementById('statusBody');
            tableBody.innerHTML = ''; // Clear the "Loading..."

            if (!appointments || appointments.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="9" style="text-align: center;">You have not created any appointments yet.</td></tr>`;
                return;
            }

            let count = 1;
            appointments.forEach(appt => {
                const row = document.createElement('tr');
                
                // Format date to be more readable
                const date = new Date(appt.date).toLocaleDateString(undefined, {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });

                row.innerHTML = `
                    <td>${count++}</td>
                    <td>${appt.ticket_code || 'N/A'}</td>
                    <td>${date || 'N/A'}</td>
                    <td>${appt.site || 'N/A'}</td>
                    <td>${appt.type_of_appointment || 'N/A'}</td>
                    <td>${appt.task_description || 'N/A'}</td>
                    <td><span class="status-pill ${statusClass(appt.status)}">${appt.status || 'Pending'}</span></td>
                    <td>${appt.priority_level || 'N/A'}</td>
                    <td><button class="btn-view" onclick="viewDetails(${appt.id})">View</button></td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // NEW: View details function (connects to real data)
        window.viewDetails = function(appointmentId) {
            // Find the appointment from our loaded data
            const task = allAppointments.find(appt => appt.id === appointmentId);
            if (!task) return;
            
            const date = new Date(task.date).toLocaleDateString(undefined, {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            document.getElementById('modalTicketNumber').textContent = task.ticket_code || 'N/A';
            document.getElementById('modalDate').textContent = date;
            document.getElementById('modalSite').textContent = task.site || 'N/A';
            document.getElementById('modalType').textContent = task.type_of_appointment || 'N/A';
            document.getElementById('modalDescription').textContent = task.task_description || 'N/A';
            document.getElementById('modalStatus').textContent = task.status || 'Pending';
            document.getElementById('modalPriority').textContent = task.priority_level || 'N/A';
            
            // These fields are not in 'appointment_records', so we set to 'N/A'
            // This is something your Project Manager would fill in later.
            document.getElementById('modalRemarks').textContent = 'Waiting for Project Manager review.';
            document.getElementById('modalEngineer').textContent = 'Not yet assigned';
            document.getElementById('modalCompletion').textContent = 'TBD';

            // We can get contact info from the user's profile
            document.getElementById('modalContact').textContent = `${userProfile.firstName} ${userProfile.surname}`;
            document.getElementById('modalPhone').textContent = userProfile.phone_number;
            
            document.getElementById('taskModal').classList.add('show');
        };
        
        // Close modal function (no change)
        window.closeModal = function() {
            document.getElementById('taskModal').classList.remove('show');
        };
        
        // Main function to run on page load
        document.addEventListener('DOMContentLoaded', function(){
            // 1. Check the user's login session
            checkUserSession();
            
            // 2. Profile menu toggle (no change)
            var btn = document.getElementById('profileBtn');
            var menu = document.getElementById('profileMenu');
            if (btn && menu) {
                btn.addEventListener('click', function(){ menu.classList.toggle('open'); });
                document.addEventListener('click', function(e){ if (!menu.contains(e.target) && !btn.contains(e.target)) { menu.classList.remove('open'); } });
            }
            
            // 3. Status filter functionality (no change, will work on dynamic rows)
            var filterSelect = document.getElementById('statusFilter');
            if (filterSelect) {
                filterSelect.addEventListener('change', function() {
                    var selectedStatus = this.value.toLowerCase();
                    var rows = document.querySelectorAll('#statusBody tr');
                    
                    rows.forEach(function(row) {
                        var statusPill = row.querySelector('.status-pill');
                        if (statusPill) {
                            var rowStatus = statusPill.textContent.toLowerCase();
                            
                            if (selectedStatus === 'all' || rowStatus === selectedStatus) {
                                row.style.display = '';
                            } else {
                                row.style.display = 'none';
                            }
                        }
                    });
                });
            }
        });
    </script>
</head>
<body>
    <header>
        <div class="container nav">
            <a href="homepage.html#home" class="brand"><img src="finsi.png" alt="FINSI" style="height:56px; width:auto;"></a>
            <nav>
                <ul id="menu">
                    <li><a href="homepage.html#home">Home</a></li>
                    <li><a href="appointment.html" id="appointmentLink">Appointment</a></li>
                    <li><a href="status.html" class="active">Status</a></li>
                </ul>
            </nav>
            <div class="auth-actions">
                <div class="profile">
                    <button type="button" class="profile-btn" id="profileBtn">
                        <span id="welcomeLabel">Loading...</span>
                        <span class="badge">...</span>
                    </button>
                    <div class="profile-dropdown" id="profileMenu">
                        <button type="button" onclick="logout()">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <main>
        <section class="page-hero">
            <div class="container">
                <h1>Your Appointments</h1>
                <div class="sub">Track statuses of your submitted appointments.</div>
            </div>
        </section>
        <section>
            <div class="container">
                <div class="card">
                    <div class="filter-bar">
                        <label for="statusFilter">Filter by Status:</label>
                        <select id="statusFilter">
                            <option value="all">All</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="ongoing">Ongoing</option>
                            <option value="rejected">Rejected</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Ticket</th>
                                <th>Date/Time</th>
                                <th>Site</th>
                                <th>Type of Appointment</th>
                                <th>Task Description/Issue</th>
                                <th>Status</th>
                                <th>Priority Level</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="statusBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>
    <footer class="footer">
        <div class="container" style="margin-top:10px; text-align:center; font-size:14px">© 2021 FINSI. All rights reserved.</div>
    </footer>
    
    <div id="taskModal" class="modal" onclick="if(event.target === this) closeModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Task Details</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="detail-row">
                    <div class="detail-label">Ticket Number:</div>
                    <div class="detail-value" id="modalTicketNumber">-</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Date & Time:</div>
                    <div class="detail-value" id="modalDate">-</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Site Location:</div>
                    <div class="detail-value" id="modalSite">-</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Appointment Type:</div>
                    <div class="detail-value" id="modalType">-</div>
                </div>
                <div class.detail-row">
                    <div class="detail-label">Description:</div>
                    <div class="detail-value" id="modalDescription">-</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Status:</div>
                    <div class="detail-value" id="modalStatus">-</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Priority Level:</div>
                    <div class="detail-value" id="modalPriority">-</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Assigned Engineer:</div>
                    <div class="detail-value" id="modalEngineer">-</div>
                </div>
                <div class.detail-row">
                    <div class="detail-label">Est. Completion:</div>
                    <div class="detail-value" id="modalCompletion">-</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Contact Person:</div>
                    <div class="detail-value" id="modalContact">-</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Contact Number:</div>
                    <div class="detail-value" id="modalPhone">-</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Remarks:</div>
                    <div class="detail-value" id="modalRemarks">-</div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>