<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Register Account</title>
    <meta name="theme-color" content="#0b5cff">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="linkcompany.css">
    <style>
        /* moved to linkcompany.css */
    </style>
    <style>
        :root {
            --brand-700: #0a3cff;
            --brand-600: #155bff;
            --brand-500: #4b79ff;
            --accent-500: #22d3ee;
            --text-900: #0b1020;
            --text-700: #2a3347;
            --text-500: #66748a;
            --bg-50: #f6f8ff;
            --white: #ffffff;
            --orange-600: #ff6b00;
            --orange-500: #ff8b13;
        }
        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body {
            margin: 0;
            font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            color: var(--text-900);
            background: radial-gradient(1200px 600px at 80% -20%, #e8efff, transparent 60%), var(--bg-50);
            line-height: 1.6;
        }
        a { color: inherit; text-decoration: none; }
        img { max-width: 100%; display: block; }
        .container { width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 20px; }

        /* Header (copied theme from landing) */
        header {
            position: sticky;
            top: 0;
            z-index: 50;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e6ecf7;
        }
        .nav { display: flex; align-items: center; justify-content: space-between; height: 80px; }
        .brand { display: inline-flex; align-items: center; gap: 10px; font-weight: 800; font-size: 24px; letter-spacing: 0.4px; }
        nav ul { display: flex; align-items: center; gap: 28px; list-style: none; margin: 0; padding: 0; }
        nav a { color: var(--text-700); font-weight: 700; font-size: 18px; position: relative; padding: 8px 2px; }
        nav a:hover { color: var(--brand-600); }
        nav a::after { content: ""; position: absolute; left: 0; right: 0; bottom: -6px; height: 2px; background: linear-gradient(90deg, var(--brand-600), var(--accent-500)); opacity: 0; transform: scaleX(0.6); transition: opacity .2s ease, transform .2s ease; }
        nav a:hover::after { opacity: 1; transform: scaleX(1); }
        .locked { opacity: .6; cursor: not-allowed; pointer-events: none; }
        .cta-btn { background: linear-gradient(135deg, var(--orange-500), var(--orange-600)); color: var(--white); padding: 10px 16px; border-radius: 999px; font-weight: 800; font-size: 14px; box-shadow: 0 8px 20px rgba(255,107,0,0.25); border: 1px solid rgba(255,107,0,0.6); }
        .btn-outline { background: transparent; color: var(--orange-600); border: 1px solid rgba(255,107,0,0.6); padding: 9px 14px; border-radius: 999px; font-weight: 800; }
        .menu-toggle { display: none; background: none; border: 0; font-size: 26px; }

        /* Page hero */
        .page-hero { padding: 24px 0 10px; }
        .eyebrow { display: inline-flex; align-items: center; gap: 10px; color: var(--orange-600); background: rgba(255,107,0,0.12); padding: 8px 14px; border-radius: 999px; font-weight: 800; font-size: 12px; letter-spacing: .6px; text-transform: uppercase; }
        h1 { font-size: 36px; margin: 12px 0 6px; }
        .sub { color: var(--text-500); }

        /* Form */
        .form-wrap { max-width: 900px; margin: 16px auto 32px; background: var(--white); border: 1px solid #e6ecf7; border-radius: 18px; box-shadow: 0 16px 40px rgba(21,91,255,0.08); padding: 22px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .field { margin: 10px 0; }
        label { display: block; font-weight: 700; margin-bottom: 6px; font-size: 14px; }
        input, textarea { width: 100%; padding: 12px 12px; border: 1px solid #dce6f5; border-radius: 12px; font: inherit; }
        input[type="file"] { padding: 10px; }
        .upload { display: grid; grid-template-columns: 44px 1fr; align-items: center; gap: 10px; border: 1px dashed #d9e4ff; padding: 10px 12px; border-radius: 12px; }
        .upload .icon { width: 36px; height: 36px; border-radius: 999px; display: grid; place-items: center; background: rgba(255,107,0,0.12); color: var(--orange-600); font-weight: 900; }
        .actions { display: flex; justify-content: center; }
        .btn-primary { background: linear-gradient(135deg, var(--orange-500), var(--orange-600)); color: #fff; padding: 14px 24px; border: 0; border-radius: 999px; font-weight: 800; cursor: pointer; box-shadow: 0 12px 26px rgba(255,107,0,0.22); }
        .muted { color: var(--text-500); font-size: 13px; }

        /* Footer */
        footer { padding: 34px 0; border-top: 1px solid #e6ecf7; background: #fbfdff; color: var(--text-500); }

        /* Toast (modern message) */
        .toast { position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%) translateY(30px); min-width: 280px; max-width: 90vw; background: #0b1020; color: #fff; padding: 14px 18px; border-radius: 12px; box-shadow: 0 16px 40px rgba(0,0,0,0.25); opacity: 0; pointer-events: none; transition: opacity .25s ease, transform .25s ease; z-index: 1000; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast.success { background: linear-gradient(135deg, #10b981, #059669); }
        .toast.error { background: linear-gradient(135deg, #ef4444, #b91c1c); }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(11, 16, 32, 0.7);
            backdrop-filter: blur(4px);
            z-index: 999;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: var(--white);
            border-radius: 18px;
            box-shadow: 0 24px 60px rgba(21, 91, 255, 0.15);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-header {
            padding: 24px 24px 16px;
            border-bottom: 1px solid #e6ecf7;
        }
        .modal-title {
            font-size: 20px;
            font-weight: 800;
            margin: 0;
            color: var(--text-900);
        }
        .modal-body {
            padding: 24px;
        }
        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #e6ecf7;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        .info-row {
            display: grid;
            grid-template-columns: 140px 1fr;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid #f0f4ff;
        }
        .info-row:last-child { border-bottom: none; }
        .info-label {
            font-weight: 700;
            color: var(--text-700);
            font-size: 14px;
        }
        .info-value {
            color: var(--text-900);
            font-size: 14px;
        }
        .btn-secondary {
            background: transparent;
            color: var(--text-700);
            border: 1px solid #dce6f5;
            padding: 12px 20px;
            border-radius: 999px;
            font-weight: 700;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-secondary:hover {
            background: #f6f8ff;
        }
        .otp-container {
            text-align: center;
            padding: 20px 0;
        }
        .otp-inputs {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin: 24px 0;
        }
        .otp-input {
            width: 56px;
            height: 56px;
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            border: 2px solid #dce6f5;
            border-radius: 12px;
            transition: border-color 0.2s;
        }
        .otp-input:focus {
            outline: none;
            border-color: var(--orange-600);
        }
        .otp-message {
            color: var(--text-500);
            font-size: 14px;
            margin-top: 16px;
        }
        .otp-email {
            color: var(--orange-600);
            font-weight: 700;
        }
        .resend-link {
            color: var(--orange-600);
            font-weight: 700;
            cursor: pointer;
            text-decoration: underline;
            margin-top: 12px;
            display: inline-block;
        }

        @media (max-width: 900px) {
            .grid-3 { grid-template-columns: 1fr; }
            .grid-2 { grid-template-columns: 1fr; }
            .info-row { grid-template-columns: 1fr; }
            .otp-inputs { gap: 8px; }
            .otp-input { width: 48px; height: 48px; font-size: 20px; }
        }
    </style>
</head>
<body>
    <header>
        <div class="container nav">
            <a href="landingpage.html#home" class="brand"><img src="finsi.png" alt="FINSI" style="height:56px; width:auto;"></a>
            <button class="menu-toggle" aria-label="Menu" onclick="toggleMenu()">☰</button>
            <nav>
                <ul id="menu">
                    <li><a href="landingpage.html#home">Home</a></li>
                    <li><a class="locked" href="landingpage.html#appointment" aria-disabled="true" title="Login required">Appointment</a></li>
                    <li><a class="locked" href="#status" aria-disabled="true" title="Login required">Status</a></li>
                </ul>
            </nav>
            <div class="auth-actions">
                <a href="login.html" class="btn-outline">Login</a>
                <a href="linkcompany.html" class="cta-btn">Register Account</a>
            </div>
        </div>
    </header>

    <main>
        <section class="page-hero">
            <div class="container">
                <span class="eyebrow">Register your account</span>
                <h1>Register Account</h1>
            </div>
        </section>

        <section>
            <div class="container">
                <div class="form-wrap" role="region" aria-labelledby="registration-form-title">
                    <div class="field">
                        <label id="registration-form-title" style="font-size: 18px;">Facility Owner Registration</label>
                        <div class="muted">Please fill in all the required information to register your account.</div>
                    </div>

                    <form id="registrationForm">
                        <div class="grid-3">
                            <div class="field">
                                <label for="firstName">First Name <span style="color: #ef4444;">*</span></label>
                                <input type="text" id="firstName" name="firstName" required>
                            </div>
                            <div class="field">
                                <label for="middleName">Middle Name</label>
                                <input type="text" id="middleName" name="middleName">
                            </div>
                            <div class="field">
                                <label for="surname">Surname <span style="color: #ef4444;">*</span></label>
                                <input type="text" id="surname" name="surname" required>
                            </div>
                        </div>

                        <div class="grid-2">
                            <div class="field">
                                <label for="companyEmail">Company Email <span style="color: #ef4444;">*</span></label>
                                <input type="email" id="companyEmail" name="companyEmail" required>
                            </div>
                            <div class="field">
                                <label for="contactNumber">Contact Number <span style="color: #ef4444;">*</span></label>
                                <input type="tel" id="contactNumber" name="contactNumber" placeholder="09xx xxx xxxx" required>
                            </div>
                        </div>

                        <div class="grid-2">
                            <div class="field">
                                <label for="location">Location <span style="color: #ef4444;">*</span></label>
                                <input type="text" id="location" name="location" placeholder="City/Province" required>
                            </div>
                            <div class="field">
                                <label for="companyName">Company Name <span style="color: #ef4444;">*</span></label>
                                <input type="text" id="companyName" name="companyName" required>
                            </div>
                        </div>

                        <div class="grid-2">
                            <div class="field">
                                <label for="password">Password <span style="color: #ef4444;">*</span></label>
                                <input type="password" id="password" name="password" minlength="6" required>
                            </div>
                            <div class="field">
                                <label for="confirmPassword">Confirm Password <span style="color: #ef4444;">*</span></label>
                                <input type="password" id="confirmPassword" name="confirmPassword" minlength="6" required>
                            </div>
                        </div>

                        <div class="actions" style="margin-top: 24px;">
                            <button type="submit" class="btn-primary">Register Account</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>
    </main>

    <div id="confirmationModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Confirm Your Registration Details</h2>
            </div>
            <div class="modal-body">
                <p class="muted" style="margin-bottom: 20px;">Please review your information carefully before proceeding. An OTP will be sent to your company email for verification.</p>
                <div id="confirmationDetails"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeConfirmationModal()">Cancel</button>
                <button type="button" class="btn-primary" id="confirm-send-btn" onclick="sendOTP()">Confirm & Send OTP</button>
            </div>
        </div>
    </div>

    <div id="otpModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Verify Your Email</h2>
            </div>
            <div class="modal-body">
                <div class="otp-container">
                    <p style="color: var(--text-700); margin-bottom: 8px;">Enter the 6-digit code sent to:</p>
                    <p class="otp-email" id="otpEmailDisplay"></p>
                    <div class="otp-inputs">
                        <input type="text" class="otp-input" maxlength="1" id="otp1" oninput="moveToNext(this, 'otp2')" onkeydown="handleBackspace(event, this, null)">
                        <input type="text" class="otp-input" maxlength="1" id="otp2" oninput="moveToNext(this, 'otp3')" onkeydown="handleBackspace(event, this, 'otp1')">
                        <input type="text" class="otp-input" maxlength="1" id="otp3" oninput="moveToNext(this, 'otp4')" onkeydown="handleBackspace(event, this, 'otp2')">
                        <input type="text" class="otp-input" maxlength="1" id="otp4" oninput="moveToNext(this, 'otp5')" onkeydown="handleBackspace(event, this, 'otp3')">
                        <input type="text" class="otp-input" maxlength="1" id="otp5" oninput="moveToNext(this, 'otp6')" onkeydown="handleBackspace(event, this, 'otp4')">
                        <input type="text" class="otp-input" maxlength="1" id="otp6" oninput="moveToNext(this, null)" onkeydown="handleBackspace(event, this, 'otp5')">
                    </div>
                    <p class="otp-message">Didn't receive the code?</p>
                    <a class="resend-link" onclick="resendOTP()">Resend OTP</a>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeOTPModal()">Cancel</button>
                <button type="button" class="btn-primary" id="verify-btn" onclick="verifyOTP()">Verify & Register</button>
            </div>
        </div>
    </div>

    <div id="validationModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Registration Submitted Successfully!</h2>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: 20px 0;">
                    <div style="width: 80px; height: 80px; margin: 0 auto 20px; border-radius: 50%; background: linear-gradient(135deg, #10b981, #059669); display: flex; align-items: center; justify-content: center; font-size: 40px; color: white;">✓</div>
                    <h3 style="color: var(--text-900); margin-bottom: 12px; font-size: 18px;">Your account is pending validation</h3>
                    <p style="color: var(--text-700); margin-bottom: 16px; line-height: 1.6;">
                        Thank you for registering! Your account has been successfully registered and is now waiting for approval.
                    </p>
                    <div style="background: #fff8f0; border: 1px solid #ffe4c4; border-radius: 12px; padding: 16px; margin: 20px 0; text-align: left;">
                        <p style="color: var(--text-700); font-size: 14px; margin: 0 0 8px 0;"><strong>⏳ What's Next?</strong></p>
                        <p style="color: var(--text-500); font-size: 13px; margin: 0; line-height: 1.6;">
                            A Project Manager will review and validate your account details. You will receive an email notification once your account has been approved.
                        </p>
                    </div>
                    <p style="color: var(--text-500); font-size: 13px; margin-top: 16px;">
                        Please check your email (<span class="otp-email" id="validationEmail"></span>) for updates.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-primary" onclick="closeValidationModal()">Got It</button>
            </div>
        </div>
    </div>

    <footer>
        <div class="container" style="margin-top:10px; text-align:center; font-size:14px">
            © 2021 FINSI. All rights reserved.
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabaseClient.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        // ---
        // ================================================================
        // INITIALIZE EMAILJS
        // ================================================================
        // ---
        // ❗️ This is your Public Key from EmailJS (Account -> API Keys)
        emailjs.init('09jja8DopIKMKbCtE');


        // --- YOUR EXISTING UI FUNCTIONS (NO CHANGES) ---
        function toggleMenu() {
            var menu = document.getElementById('menu');
            if (menu) menu.classList.toggle('open');
        }
        window.toggleMenu = toggleMenu;

        let registrationData = {}; // Store form data

        document.getElementById('registrationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            registrationData = {
                firstName: document.getElementById('firstName').value,
                middleName: document.getElementById('middleName').value,
                surname: document.getElementById('surname').value,
                companyEmail: document.getElementById('companyEmail').value,
                contactNumber: document.getElementById('contactNumber').value,
                location: document.getElementById('location').value,
                companyName: document.getElementById('companyName').value,
                password: document.getElementById('password').value,
                confirmPassword: document.getElementById('confirmPassword').value
            };

            if (registrationData.password !== registrationData.confirmPassword) {
                showToast('Passwords do not match!', 'error');
                return;
            }
            if (registrationData.password.length < 6) {
                showToast('Password must be at least 6 characters long', 'error');
                return;
            }

            showConfirmationModal();
        });

        function showConfirmationModal() {
            const detailsHTML = `
                <div class="info-row">
                    <div class="info-label">Full Name:</div>
                    <div class="info-value">${registrationData.firstName} ${registrationData.middleName || ''} ${registrationData.surname}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">Company Email:</div>
                    <div class="info-value">${registrationData.companyEmail}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">Contact Number:</div>
                    <div class="info-value">${registrationData.contactNumber}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">Location:</div>
                    <div class="info-value">${registrationData.location}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">Company Name:</div>
                    <div class="info-value">${registrationData.companyName}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">Password:</div>
                    <div class="info-value">••••••••</div>
                </div>
            `;
            document.getElementById('confirmationDetails').innerHTML = detailsHTML;
            document.getElementById('confirmationModal').classList.add('show');
        }

        function closeConfirmationModal() {
            document.getElementById('confirmationModal').classList.remove('show');
        }

        function closeOTPModal() {
            document.getElementById('otpModal').classList.remove('show');
            for (let i = 1; i <= 6; i++) {
                document.getElementById('otp' + i).value = '';
            }
        }

        function moveToNext(current, nextId) {
            if (current.value.length === 1 && nextId) {
                document.getElementById(nextId).focus();
            }
        }

        function handleBackspace(event, current, prevId) {
            if (event.key === 'Backspace' && current.value === '' && prevId) {
                document.getElementById(prevId).focus();
            }
        }
        
        function showValidationModal() {
            document.getElementById('validationEmail').textContent = registrationData.companyEmail;
            document.getElementById('validationModal').classList.add('show');
        }

        function closeValidationModal() {
            document.getElementById('validationModal').classList.remove('show');
            document.getElementById('registrationForm').reset();
            // Redirect to login page after success
            window.location.href = 'login.html';
        }

        function showToast(message, type = 'success') {
            let toast = document.getElementById('toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast';
                toast.className = 'toast';
                document.body.appendChild(toast);
            }
            toast.textContent = message;
            toast.className = 'toast ' + type;
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ---
        // ================================================================
        // MODIFIED SUPABASE & EMAILJS FUNCTIONS
        // ================================================================
        // ---

        /**
         * Step 1 - Send a custom OTP using EmailJS
         */
        async function sendOTP() {
            const btn = document.getElementById('confirm-send-btn');
            btn.disabled = true;
            btn.textContent = 'Sending...';
            closeConfirmationModal();

            try {
                // Generate a 6-digit OTP
                const otp = Math.floor(100000 + Math.random() * 900000).toString();

                // Store OTP for verification. 
                // WARNING: localStorage is not secure. This is for demonstration.
                localStorage.setItem('registrationOTP', otp);
                localStorage.setItem('registrationEmail', registrationData.companyEmail);

                // Send OTP via EmailJS
                const templateParams = {
                    to_email: registrationData.companyEmail,
                    otp_code: otp,
                    user_name: registrationData.firstName + ' ' + registrationData.surname
                };

                // ❗️ These are your real EmailJS keys
                await emailjs.send('service_qj1yc6w', 'template_fbiv2i9', templateParams);
                
                showToast('OTP sent to ' + registrationData.companyEmail, 'success');

                // Show OTP modal
                document.getElementById('otpEmailDisplay').textContent = registrationData.companyEmail;
                document.getElementById('otpModal').classList.add('show');
                setTimeout(() => {
                    document.getElementById('otp1').focus();
                }, 300);

            } catch (err) {
                console.error('EmailJS Error:', err);
                showToast('Failed to send OTP. Check EmailJS keys.', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Confirm & Send OTP';
            }
        }

        /**
         * Step 2 - Verify the EmailJS OTP and create the Supabase user
         */
        async function verifyOTP() {
            const btn = document.getElementById('verify-btn');
            btn.disabled = true;
            btn.textContent = 'Verifying...';

            let otp = '';
            for (let i = 1; i <= 6; i++) {
                otp += document.getElementById('otp' + i).value;
            }

            // 1. Check OTP against stored value
            const storedOTP = localStorage.getItem('registrationOTP');
            const storedEmail = localStorage.getItem('registrationEmail');

            if (otp !== storedOTP || storedEmail !== registrationData.companyEmail) {
                showToast('Invalid OTP code', 'error');
                btn.disabled = false;
                btn.textContent = 'Verify & Register';
                return;
            }

            // 2. OTP is valid! Now, create the Supabase user.
            try {
                // Sign up the user. 'Confirm email' MUST be OFF in Supabase.
                const { data, error } = await supabase.auth.signUp({
                    email: registrationData.companyEmail,
                    password: registrationData.password,
                });

                if (error) {
                    showToast('Error creating account: ' + error.message, 'error');
                    btn.disabled = false;
                    btn.textContent = 'Verify & Register';
                    return;
                }
                
                // 3. THE FIX: Check if data.user exists
                if (!data || !data.user) {
                    showToast('Account creation failed. Is "Confirm email" OFF in Supabase?', 'error');
                    btn.disabled = false;
                    btn.textContent = 'Verify & Register';
                    return;
                }

                showToast('Account created successfully!', 'success');

                // 4. Insert user profile into facility_owner_records
                //    !! USE data.user.id FROM THE SIGNUP RESPONSE !!
                //    !! COLUMN NAMES ARE NOW CORRECTED !!
                const { error: insertError } = await supabase
                    .from('facility_owner_records')
                    .insert([
                        {
                            user_id: data.user.id, // <-- THE FIX
                            "firstName": registrationData.firstName,
                            "middleName": registrationData.middleName,
                            surname: registrationData.surname,
                            email: registrationData.companyEmail,
                            phone_number: registrationData.contactNumber,
                            address: registrationData.location,
                            company_name: registrationData.companyName
                        }
                    ]);

                if (insertError) {
                    showToast('Error saving profile: ' + insertError.message, 'error');
                    // In a real app, you might want to delete the auth user here for cleanup
                    btn.disabled = false;
                    btn.textContent = 'Verify & Register';
                    return;
                }

                // 5. Clear stored OTP and sign out
                localStorage.removeItem('registrationOTP');
                localStorage.removeItem('registrationEmail');
                await supabase.auth.signOut();

                // 6. Show validation pending modal
                setTimeout(() => {
                    closeOTPModal();
                    showValidationModal();
                }, 1000);

            } catch (err) {
                console.error(err);
                showToast('Registration failed. Please try again.', 'error');
            } finally {
                // This runs whether it succeeds or fails, to re-enable the button
                btn.disabled = false;
                btn.textContent = 'Verify & Register';
            }
        }

        /**
         * Step 3 - Resend the EmailJS OTP
         */
        async function resendOTP() {
            showToast('Resending code...', 'success');
            try {
                // Generate a new 6-digit OTP
                const otp = Math.floor(100000 + Math.random() * 900000).toString();

                // Update stored OTP
                localStorage.setItem('registrationOTP', otp);

                // Send OTP via EmailJS
                const templateParams = {
                    to_email: registrationData.companyEmail,
                    otp_code: otp,
                    user_name: registrationData.firstName + ' ' + registrationData.surname
                };
                
                // ❗️ These are your real EmailJS keys
                await emailjs.send('service_qj1yc6w', 'template_fbiv2i9', templateParams);

                showToast('OTP resent to ' + registrationData.companyEmail, 'success');
                for (let i = 1; i <= 6; i++) {
                    document.getElementById('otp' + i).value = '';
                }
                document.getElementById('otp1').focus();

            } catch (err) {
                console.error(err);
                showToast('Failed to resend OTP. Please try again.', 'error');
            }
        }
    </script>
</body>
</html>