<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FINSI â€” Project Manager</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="pm.css">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabaseClient.js"></script>
    <style>
        /* (Your pm.css styles) */
        :root { --brand-700:#0a3cff; --brand-600:#155bff; --accent-500:#22d3ee; --text-900:#0b1020; --text-700:#2a3347; --text-500:#66748a; --bg-50:#f6f8ff; --white:#ffffff; }
        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body { margin:0; font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:var(--text-900); background: radial-gradient(1200px 600px at 80% -20%, #e8efff, transparent 60%), var(--bg-50); display:flex; flex-direction:column; min-height:100vh; }
        main { flex:1; }
        .container { width:100%; max-width:1200px; margin:0 auto; padding:0 20px; }
        header { position:sticky; top:0; z-index:50; background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); border-bottom:1px solid #e6ecf7; }
        /* (all your other styles) */
    </style>
</head>
<body>
    <div class="layout">
        <aside class="sidebar">
            <div class="userbox">
                <img class="avatar" src="profile.jpg" alt="Profile">
                <div class="username" id="pmName">Loading...</div>
            </div>
            <nav>
                <ul class="navlist">
                    <li><a class="nav-link active" data-view="dashboard" href="#"><span class="nav-icon">ðŸ“Š</span>Dashboard</a></li>
                    <li>
                        <a class="nav-link has-children" data-toggle="accounts" href="#"><span class="nav-icon">ðŸ‘¥</span>Accounts<span class="nav-caret">â–¾</span></a>
                        <ul class="nav-sublist" id="accounts-subnav" style="display:none;">
                            <li><a class="nav-link" data-view="account-management" href="#">Facility Owner Account Management</a></li>
                            <li><a class="nav-link" data-view="engineers" href="#">Engineers</a></li>
                        </ul>
                    </li>
                    <li>
                        <a class="nav-link has-children" data-toggle="appointments" href="#"><span class="nav-icon">ðŸ“…</span>Appointments<span class="nav-caret">â–¾</span></a>
                        <ul class="nav-sublist" id="appointments-subnav" style="display:none;">
                            <li><a class="nav-link" data-view="request-appointments" href="#">Request Appointments</a></li>
                            </ul>
                    </li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <a class="logout" onclick="logout()"><span class="nav-icon">â†—</span>Logout</a>
            </div>
        </aside>
        <div>
            <div class="topbar">
                <div class="welcome-text" id="welcomeText">Welcome, Project Manager!</div>
                <div class="finsi-logo">
                    <img src="finsi.png" alt="FINSI Logo" class="logo-image">
                </div>
            </div>
            <div class="content">
                <div id="dashboard-view" class="view-section active">
                    <div class="dashboard-grid">
                        <div class="dashboard-overview">
                            <h2 class="overview-title">Dashboard Overview</h2>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon">ðŸŽ«</div>
                                <div class="stat-number" id="totalTickets">0</div>
                                <div class="stat-label">Pending Appointments</div>
                            </div>
                            <div class="stat-card" onclick="navigateToAccounts('pending')" style="cursor: pointer;">
                                <div class="stat-icon">ðŸ‘¥</div>
                                <div class="stat-number" id="pendingFOAccounts">0</div>
                                <div class="stat-label">Pending FO Accounts</div>
                            </div>
                        </div>
                        </div>
                        
                        <div class="calendar-widget">
                            <div class="calendar-header">
                                <h3 class="calendar-title" id="calendarTitle">Calendar</h3>
                            </div>
                            <div class="calendar-grid" id="calendarGrid">
                                <p style="text-align: center; padding: 20px; color: var(--text-500);">Calendar view coming soon.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="account-management-view" class="view-section">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Facility Owner Account Management</h2>
                            <input id="searchAccounts" type="text" placeholder="Search by name, company, or email">
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="table" id="accountsTable">
                                <thead>
                                    <tr>
                                        <th>Full Name</th>
                                        <th>Company Name</th>
                                        <th>Email</th>
                                        <th>Contact Number</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="accountsBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="engineers-view" class="view-section">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Engineers</h2>
                            <input id="searchEngineers" type="text" placeholder="Search engineers">
                        </div>
                        <table class="table" id="engineersTable">
                            <thead>
                                <tr>
                                    <th>Full Name</th>
                                    <th>Email Address</th>
                                    <th>Phone Number</th>
                                    <th>Location/Coverage</th>
                                </tr>
                            </thead>
                            <tbody id="engineersBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="request-appointments-view" class="view-section">
                    <div class="card">
                        <div class="card-header"><h2 class="card-title">Request Appointments</h2></div>
                        <div class="searchbar"><input id="searchRequestAppointments" type="text" placeholder="Search appointments..."></div>
                        <table class="table" id="requestAppointmentsTable">
                            <thead>
                                <tr>
                                    <th>Ticket</th>
                                    <th>Date</th>
                                    <th>Site</th>
                                    <th>Type</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th>Priority</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="requestAppointmentsBody"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="ticketOverviewModal" class="modal-overlay" onclick="closeTicketOverviewModal()">
        <div class="ticket-overview-modal-card" onclick="event.stopPropagation()">
            <div class="ticket-overview-modal-header">
                <h3 class="ticket-overview-modal-title">Assign Appointment</h3>
                <button type="button" class="ticket-overview-close-btn" onclick="closeTicketOverviewModal()">Ã—</button>
            </div>
            <div class="ticket-overview-modal-body">
                <div class="ticket-info-section">
                    <h4 class="section-title">Ticket Information</h4>
                    <div class="ticket-info-grid">
                        <div class="info-item">
                            <label class="info-label">Ticket Number</label>
                            <div class="info-value" id="overviewTicket">â€”</div>
                        </div>
                        <div class="info-item">
                            <label class="info-label">Date & Time</label>
                            <div class="info-value" id="overviewDate">â€”</div>
                        </div>
                        <div class="info-item">
                            <label class="info-label">Priority</label>
                            <div class="info-value" id="overviewPriority">â€”</div>
                        </div>
                        <div class="info-item full-width">
                            <label class="info-label">Site Location</label>
                            <div class="info-value" id="overviewSite">â€”</div>
                        </div>
                        <div class="info-item full-width">
                            <label class="info-label">Task Description / Issue</label>
                            <div class="info-value" id="overviewDescription">â€”</div>
                        </div>
                    </div>
                </div>

                <div class="engineer-assignment-section" id="engineerAssignmentSection">
                    <h4 class="section-title">Engineer Assignment</h4>
                    <form id="assignmentForm">
                        <input type="hidden" id="currentAppointmentId">
                        <div class="form-field">
                            <label class="form-label">Assign Engineer</label>
                            <select class="form-select" id="engineerSelect" required>
                                <option value="">Select an engineer...</option>
                            </select>
                        </div>
                        <div class="form-field" id="pmRemarksField">
                            <label class="form-label">PM Remarks to Engineer</label>
                            <textarea class="form-textarea" id="pmRemarksText" rows="3" placeholder="Enter remarks for the assigned engineer..."></textarea>
                        </div>
                        <div class="action-buttons-section" style="margin-top: 20px;">
                            <button type="submit" class="action-btn process-btn" id="processBtn">
                                <span class="btn-icon">âš¡</span>
                                Assign & Process Ticket
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="accountDetailModal" class="modal-overlay" style="display:none" onclick="closeAccountDetailModal()">
        <div class="assignment-modal-card" onclick="event.stopPropagation()" style="max-width: 600px;">
            <div class="assignment-modal-header">
                <div class="assignment-modal-title"><span class="assignment-icon">ðŸ‘¤</span><h3>Account Details</h3></div>
            </div>
            <div class="assignment-modal-body">
                <div style="display: flex; flex-direction: column; gap: 16px;">
                    <div class="detail-row"><span class="detail-label">Full Name:</span><span id="accountDetailName">-</span></div>
                    <div class="detail-row"><span class="detail-label">Company:</span><span id="accountDetailCompany">-</span></div>
                    <div class="detail-row"><span class="detail-label">Email:</span><span id="accountDetailEmail">-</span></div>
                    <div class="detail-row"><span class_label">Phone:</span><span id="accountDetailPhone">-</span></div>
                    <div class="detail-row"><span class="detail-label">Location:</span><span id="accountDetailLocation">-</span></div>
                    <div class="detail-row"><span class="detail-label">Status:</span><span id="accountDetailStatus" class="status-pill status-pending">-</span></div>
                </div>
                <div class="assignment-form-actions" style="margin-top: 24px;">
                    <button type="button" class="assignment-btn assignment-btn-cancel" onclick="closeAccountDetailModal()">Close</button>
                    <button type="button" id="accountApproveBtn" class="assignment-btn assignment-btn-assign" style="background: #10b981;">Approve</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state to hold all our data
        const state = {
            currentUser: null,
            pmProfile: null,
            pendingAppointments: [],
            pendingAccounts: [],
            engineers: []
        };

        // --- 1. AUTHENTICATION ---

        async function logout() {
            await supabase.auth.signOut();
            window.location.href = 'pm_login.html';
        }

        async function checkPMSession() {
            const { data, error } = await supabase.auth.getSession();
            if (error || !data.session) {
                console.log('No session, redirecting to PM login.');
                window.location.href = 'pm_login.html';
                return;
            }
            state.currentUser = data.session.user;

            // Verify this user is a Project Manager
            const { data: profile, error: profileError } = await supabase
                .from('project_manager_records')
                .select('*')
                .eq('user_id', state.currentUser.id)
                .single();

            if (profileError || !profile) {
                console.error('Not a PM or profile not found.', profileError);
                await logout(); // Not a PM, log them out
                return;
            }

            state.pmProfile = profile;
            
            // User is a real PM, update UI and load data
            updatePMHeader();
            loadDashboardData();
        }

        function updatePMHeader() {
            const pmName = document.getElementById('pmName');
            const welcomeText = document.getElementById('welcomeText');
            const name = state.pmProfile.firstName || state.pmProfile.email;
            if (pmName) pmName.textContent = name;
            if (welcomeText) welcomeText.textContent = `Welcome, ${name}!`;
        }

        // --- 2. DATA LOADING ---

        async function loadDashboardData() {
            // Fetch all data from our new backend endpoint
            try {
                const response = await fetch('http://localhost:3000/api/pm/dashboard-data');
                if (!response.ok) {
                    throw new Error('Failed to fetch dashboard data.');
                }
                const data = await response.json();

                // Store data in our global state
                state.pendingAppointments = data.pendingAppointments || [];
                state.pendingAccounts = data.pendingAccounts || [];
                state.engineers = data.engineers || [];

                // Render all components
                renderDashboardStats();
                renderRequestAppointments();
                renderAccounts();
                renderEngineers();
                populateEngineerDropdown();

            } catch (error) {
                console.error(error.message);
                alert('Could not load dashboard data. Is the backend server running?');
            }
        }

        // --- 3. DATA RENDERING ---

        function renderDashboardStats() {
            const totalEl = document.getElementById('totalTickets');
            const pendingFOEl = document.getElementById('pendingFOAccounts');
            if (totalEl) totalEl.textContent = state.pendingAppointments.length;
            if (pendingFOEl) pendingFOEl.textContent = state.pendingAccounts.length;
        }

        function renderRequestAppointments() {
            const tbody = document.getElementById('requestAppointmentsBody');
            if (!tbody) return;
            tbody.innerHTML = ''; // Clear

            if (state.pendingAppointments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No pending appointments.</td></tr>';
                return;
            }

            state.pendingAppointments.forEach((appt) => {
                const row = document.createElement('tr');
                const date = new Date(appt.date).toLocaleDateString();
                row.innerHTML = `
                    <td>${appt.ticket_code || 'N/A'}</td>
                    <td>${date}</td>
                    <td>${appt.site || 'N/A'}</td>
                    <td>${appt.type_of_appointment || 'N/A'}</td>
                    <td>${appt.task_description || 'N/A'}</td>
                    <td><span class="status-pill status-pending">${appt.status}</span></td>
                    <td>${appt.priority_level || 'N/A'}</td>
                    <td><div class="row-actions"><button class="action-btn" onclick="openAssignModal(${appt.id})">Assign</button></div></td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderAccounts() {
            const tbody = document.getElementById('accountsBody');
            if (!tbody) return;
            tbody.innerHTML = ''; // Clear

            if (state.pendingAccounts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No accounts to approve.</td></tr>';
                return;
            }

            state.pendingAccounts.forEach(acc => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${acc.firstName || ''} ${acc.surname || ''}</td>
                    <td>${acc.company_name || 'N/A'}</td>
                    <td>${acc.email || 'N/A'}</td>
                    <td>${acc.phone_number || 'N/A'}</td>
                    <td><span class="status-pill status-pending">${acc.status}</span></td>
                    <td><button class="action-btn" onclick="openApproveModal('${acc.user_id}')">View</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderEngineers() {
            const tbody = document.getElementById('engineersBody');
            if (!tbody) return;
            tbody.innerHTML = ''; // Clear

            state.engineers.forEach(eng => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${eng.firstName || ''} ${eng.lastName || ''}</td>
                    <td>${eng.email || 'N/A'}</td>
                    <td>${eng.phone_number || 'N/A'}</td>
                    <td>${eng.location || 'N/A'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function populateEngineerDropdown() {
            const select = document.getElementById('engineerSelect');
            if (!select) return;
            select.innerHTML = '<option value="">Select an engineer...</option>'; // Reset
            
            state.engineers.forEach(eng => {
                const option = document.createElement('option');
                option.value = eng.user_id; // Assign the engineer's UUID
                option.textContent = `${eng.firstName || ''} ${eng.lastName || ''} (${eng.location || 'N/A'})`;
                select.appendChild(option);
            });
        }

        // --- 4. MODAL & ACTIONS ---

        // View/Approve Account Modal
        function openApproveModal(userId) {
            const acc = state.pendingAccounts.find(a => a.user_id === userId);
            if (!acc) return;

            // Set the onclick for the approve button
            document.getElementById('accountApproveBtn').onclick = () => approveAccount(acc.user_id);
            
            document.getElementById('accountDetailName').textContent = `${acc.firstName || ''} ${acc.surname || ''}`;
            document.getElementById('accountDetailCompany').textContent = acc.company_name || 'N/A';
            document.getElementById('accountDetailEmail').textContent = acc.email || 'N/A';
            document.getElementById('accountDetailPhone').textContent = acc.phone_number || 'N/A';
            document.getElementById('accountDetailLocation').textContent = acc.address || 'N/A';
            document.getElementById('accountDetailStatus').textContent = acc.status;

            document.getElementById('accountDetailModal').style.display = 'flex';
        }

        function closeAccountDetailModal() {
            document.getElementById('accountDetailModal').style.display = 'none';
        }

        async function approveAccount(userId) {
            try {
                const response = await fetch('http://localhost:3000/api/pm/approve-account', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error);

                alert('Account approved!');
                closeAccountDetailModal();
                loadDashboardData(); // Refresh all data

            } catch (error) {
                alert('Error approving account: ' + error.message);
            }
        }

        // Assign Appointment Modal
        function openAssignModal(appointmentId) {
            const appt = state.pendingAppointments.find(a => a.id === appointmentId);
            if (!appt) return;

            document.getElementById('currentAppointmentId').value = appt.id;
            document.getElementById('overviewTicket').textContent = appt.ticket_code || 'N/A';
            document.getElementById('overviewDate').textContent = new Date(appt.date).toLocaleDateString();
            document.getElementById('overviewPriority').textContent = appt.priority_level || 'N/A';
            document.getElementById('overviewSite').textContent = appt.site || 'N/A';
            document.getElementById('overviewDescription').textContent = appt.task_description || 'N/A';
            
            document.getElementById('pmRemarksText').value = ''; // Clear remarks
            document.getElementById('engineerSelect').value = ''; // Reset dropdown

            document.getElementById('ticketOverviewModal').style.display = 'flex';
        }
        
        function closeTicketOverviewModal() {
            document.getElementById('ticketOverviewModal').style.display = 'none';
        }
        
        // Handle the "Assign" form submission
        document.getElementById('assignmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const btn = document.getElementById('processBtn');
            btn.disabled = true;

            const appointment_id = document.getElementById('currentAppointmentId').value;
            const engineer_id = document.getElementById('engineerSelect').value;
            const pm_remarks = document.getElementById('pmRemarksText').value;

            if (!engineer_id) {
                alert('Please select an engineer.');
                btn.disabled = false;
                return;
            }

            try {
                const response = await fetch('http://localhost:3000/api/pm/assign-appointment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ appointment_id, engineer_id, pm_remarks })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error);

                alert('Appointment assigned successfully!');
                closeTicketOverviewModal();
                loadDashboardData(); // Refresh all data

            } catch (error) {
                alert('Error assigning appointment: ' + error.message);
            } finally {
                btn.disabled = false;
            }
        });

        // --- 5. INITIALIZATION & HELPERS ---

        // Simple navigation
        function initNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            const viewSections = document.querySelectorAll('.view-section');
            
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const viewName = link.getAttribute('data-view');
                    if (!viewName) return; // Not a view link

                    viewSections.forEach(section => section.classList.remove('active'));
                    navLinks.forEach(nav => nav.classList.remove('active'));

                    link.classList.add('active');
                    const targetView = document.getElementById(viewName + '-view');
                    if (targetView) targetView.classList.add('active');

                    // Handle sub-nav parents
                    const parentUl = link.closest('ul.nav-sublist');
                    if (parentUl) {
                        const parentLink = parentUl.previousElementSibling;
                        if(parentLink) parentLink.classList.add('active');
                    }
                });
            });

            // Handle dropdown toggles
            document.querySelectorAll('[data-toggle]').forEach(toggle => {
                toggle.addEventListener('click', (e) => {
                    e.preventDefault();
                    const subnavId = toggle.getAttribute('data-toggle') + '-subnav';
                    const subnav = document.getElementById(subnavId);
                    if (subnav) {
                        subnav.style.display = subnav.style.display === 'block' ? 'none' : 'block';
                    }
                });
            });
        }
        
        function navigateToAccounts(filterStatus) {
             const link = document.querySelector('[data-view="account-management"]');
             if(link) link.click();
             
             const statusFilter = document.getElementById('accountStatusFilter');
             if (statusFilter && filterStatus) {
                 statusFilter.value = filterStatus;
                 // We'll need to add a filter function later
             }
        }

        // Run all initialization on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkPMSession(); // Start authentication
            initNavigation(); // Set up the sidebar links
        });

    </script>
</body>
</html>